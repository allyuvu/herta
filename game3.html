<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹å‹¢è™›æ“¬é‹¼ç´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* æ¨™é¡Œå€ */
        .header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 20px;
        }

        .game-title {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #f8cdda, #1d2b64);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(248, 205, 218, 0.3);
            letter-spacing: 2px;
        }

        .piano-emoji {
            font-size: 4rem;
            margin-bottom: 10px;
            animation: float 3s ease-in-out infinite;
            display: inline-block;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .subtitle {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.8);
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* ä¸»éŠæˆ²å€ */
        .main-game {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 20px;
        }

        /* ç›¸æ©Ÿå€åŸŸ */
        .camera-container {
            flex: 2;
            min-width: 300px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            overflow: hidden;
            border: 4px solid rgba(248, 205, 218, 0.3);
            backdrop-filter: blur(10px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            position: relative;
        }

        .camera-feed {
            width: 100%;
            height: 500px;
            object-fit: cover;
            display: block;
            background: #000;
        }

        /* éŠæˆ²ç•«å¸ƒ */
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 500px;
            z-index: 2;
            pointer-events: none;
        }

        /* æ‰‹éƒ¨æŒ‡ç¤ºå™¨ */
        .hand-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 15px;
            border: 2px solid rgba(248, 205, 218, 0.5);
            z-index: 3;
            backdrop-filter: blur(10px);
            min-width: 200px;
        }

        .hand-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .hand-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #f8cdda;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .hand-text {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .finger-info {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* é‹¼ç´æ§åˆ¶é¢æ¿ */
        .piano-panel {
            flex: 1;
            min-width: 300px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            padding: 30px;
            border: 4px solid rgba(29, 43, 100, 0.3);
            backdrop-filter: blur(10px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
        }

        .panel-title {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: #f8cdda;
            text-align: center;
            border-bottom: 2px solid rgba(248, 205, 218, 0.3);
            padding-bottom: 15px;
        }

        /* é‹¼ç´éµç›¤é¡¯ç¤º */
        .keyboard-display {
            flex: 1;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .keyboard-keys {
            display: flex;
            justify-content: center;
            height: 150px;
            position: relative;
        }

        .piano-key {
            position: relative;
            margin: 0 2px;
            transition: all 0.1s ease;
        }

        .white-key {
            width: 40px;
            height: 150px;
            background: linear-gradient(to bottom, #fff 0%, #f0f0f0 100%);
            border-radius: 0 0 8px 8px;
            border: 2px solid #333;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .black-key {
            width: 28px;
            height: 100px;
            background: linear-gradient(to bottom, #333 0%, #000 100%);
            border-radius: 0 0 6px 6px;
            position: absolute;
            top: 0;
            z-index: 2;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.5);
        }

        .piano-key.active {
            transform: translateY(5px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .white-key.active {
            background: linear-gradient(to bottom, #f8cdda 0%, #f0b4c8 100%);
        }

        .black-key.active {
            background: linear-gradient(to bottom, #666 0%, #444 100%);
        }

        /* é‹¼ç´è¨­å®š */
        .piano-settings {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-label {
            display: block;
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }

        .octave-selector {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .octave-btn {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            margin: 0 5px;
            text-align: center;
        }

        .octave-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .octave-btn.active {
            background: linear-gradient(45deg, #f8cdda, #1d2b64);
            border-color: transparent;
            box-shadow: 0 5px 15px rgba(248, 205, 218, 0.3);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: linear-gradient(45deg, #f8cdda, #1d2b64);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .slider-value {
            min-width: 40px;
            text-align: right;
            color: #fff;
            font-weight: 500;
        }

        /* éŠæˆ²çµ±è¨ˆ */
        .game-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(248, 205, 218, 0.3);
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #f8cdda;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: auto;
        }

        .control-btn {
            padding: 18px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-btn.primary {
            background: linear-gradient(45deg, #f8cdda, #e8adc8);
            color: #000;
            box-shadow: 0 5px 15px rgba(248, 205, 218, 0.4);
        }

        .control-btn.primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(248, 205, 218, 0.6);
        }

        .control-btn.secondary {
            background: linear-gradient(45deg, #1d2b64, #0f0c29);
            color: white;
            box-shadow: 0 5px 15px rgba(29, 43, 100, 0.4);
        }

        .control-btn.secondary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(29, 43, 100, 0.6);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* æ¨‚æ›²é¸æ“‡ */
        .song-selection {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            max-height: 200px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(248, 205, 218, 0.3);
            backdrop-filter: blur(10px);
            z-index: 100;
            overflow-y: auto;
        }

        .song-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #f8cdda;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .song-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .song-btn {
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .song-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .song-btn.active {
            background: linear-gradient(45deg, #f8cdda, #1d2b64);
            border-color: transparent;
        }

        /* æ‰‹å‹¢æç¤º */
        .gesture-hint {
            position: fixed;
            bottom: 240px;
            right: 20px;
            width: 300px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(29, 43, 100, 0.3);
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .hint-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #f8cdda;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hint-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .hint-item {
            display: flex;
            align-items: center;
            gap: 12px;
            color: rgba(255, 255, 255, 0.8);
        }

        .hint-icon {
            font-size: 1.5rem;
            width: 30px;
            text-align: center;
        }

        .hint-text {
            font-size: 0.9rem;
        }

        /* æ¬Šé™æç¤º */
        #permissionPrompt {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .prompt-content {
            background: linear-gradient(135deg, #f8cdda, #1d2b64);
            padding: 50px;
            border-radius: 25px;
            text-align: center;
            max-width: 600px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .prompt-title {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #000;
        }

        .prompt-message {
            font-size: 1.2rem;
            margin-bottom: 30px;
            line-height: 1.6;
            color: rgba(0, 0, 0, 0.8);
        }

        .prompt-btn {
            background: #000;
            color: white;
            border: none;
            padding: 18px 50px;
            font-size: 1.3rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .prompt-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        /* è¼‰å…¥ç•«é¢ */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loader {
            width: 80px;
            height: 80px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top-color: #f8cdda;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 30px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.5rem;
            color: white;
            letter-spacing: 2px;
        }

        /* éŸ³ç¬¦è¦–è¦ºåŒ– */
        .note-visualizer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 500px;
            pointer-events: none;
            overflow: hidden;
            z-index: 1;
        }

        .note-particle {
            position: absolute;
            font-size: 2rem;
            animation: noteFloat 3s ease-out forwards;
            opacity: 0;
        }

        @keyframes noteFloat {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(0.5);
                opacity: 0;
            }
        }

        /* è‡ªè¨‚æ»¾å‹•æ¢ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(248, 205, 218, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(248, 205, 218, 0.7);
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 1200px) {
            .main-game {
                flex-direction: column;
            }
            
            .camera-container,
            .piano-panel {
                width: 100%;
            }
            
            .game-title {
                font-size: 2.5rem;
            }
            
            .piano-emoji {
                font-size: 3rem;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 15px 0;
            }
            
            .game-title {
                font-size: 2rem;
            }
            
            .subtitle {
                font-size: 1rem;
                padding: 0 10px;
            }
            
            .camera-feed {
                height: 400px;
            }
            
            #gameCanvas {
                height: 400px;
            }
            
            .song-selection,
            .gesture-hint {
                width: calc(100% - 40px);
                left: 20px;
                right: 20px;
            }
            
            .song-selection {
                bottom: 20px;
            }
            
            .gesture-hint {
                bottom: 260px;
            }
            
            .white-key {
                width: 30px;
            }
            
            .black-key {
                width: 20px;
            }
        }

        @media (max-width: 480px) {
            .game-title {
                font-size: 1.8rem;
            }
            
            .piano-emoji {
                font-size: 2.5rem;
            }
            
            .camera-feed {
                height: 300px;
            }
            
            #gameCanvas {
                height: 300px;
            }
            
            .game-stats {
                grid-template-columns: 1fr;
            }
            
            .white-key {
                width: 25px;
            }
            
            .black-key {
                width: 16px;
            }
            
            .octave-selector {
                flex-wrap: wrap;
            }
            
            .octave-btn {
                flex: none;
                width: calc(50% - 10px);
                margin-bottom: 10px;
            }
        }

        /* æ¨‚è­œé¡¯ç¤ºå™¨ */
        .sheet-music {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .sheet-title {
            font-size: 1.1rem;
            color: #f8cdda;
            margin-bottom: 10px;
        }

        .note-sequence {
            font-family: monospace;
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
        }

        .note-sequence .current {
            color: #f8cdda;
            font-weight: bold;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- è¼‰å…¥ç•«é¢ -->
    <div id="loadingScreen">
        <div class="loader"></div>
        <div class="loading-text">è¼‰å…¥é‹¼ç´éŠæˆ²ä¸­...</div>
    </div>

    <!-- éŸ³ç¬¦è¦–è¦ºåŒ–å€åŸŸ -->
    <div class="note-visualizer" id="noteVisualizer"></div>

    <div class="container">
        <!-- æ¨™é¡Œå€ -->
        <header class="header">
            <div class="piano-emoji">ğŸ¹</div>
            <h1 class="game-title">æ‰‹å‹¢è™›æ“¬é‹¼ç´</h1>
            <p class="subtitle">ä½¿ç”¨æ‰‹æŒ‡åœ¨ç©ºä¸­å½ˆå¥é‹¼ç´ï¼è®“æ”å½±æ©Ÿåµæ¸¬ä½ çš„æ‰‹å‹¢ï¼Œé–‹å§‹ä½ çš„éŸ³æ¨‚å‰µä½œä¹‹æ—…ï¼</p>
        </header>

        <!-- ä¸»éŠæˆ²å€ -->
        <div class="main-game">
            <!-- ç›¸æ©Ÿå€åŸŸ -->
            <div class="camera-container">
                <video class="camera-feed" id="cameraFeed"></video>
                <canvas id="gameCanvas"></canvas>
                
                <!-- æ‰‹éƒ¨æŒ‡ç¤ºå™¨ -->
                <div class="hand-indicator">
                    <div class="hand-status">
                        <div class="hand-dot"></div>
                        <div class="hand-text" id="handStatusText">åµæ¸¬æ‰‹éƒ¨ä¸­...</div>
                    </div>
                    <div class="finger-info" id="fingerInfo">ä½¿ç”¨é£ŸæŒ‡å½ˆå¥é‹¼ç´éµ</div>
                </div>
            </div>

            <!-- é‹¼ç´æ§åˆ¶é¢æ¿ -->
            <div class="piano-panel">
                <h2 class="panel-title">ğŸµ é‹¼ç´æ§åˆ¶å°</h2>
                
                <!-- é‹¼ç´éµç›¤é¡¯ç¤º -->
                <div class="keyboard-display">
                    <div class="keyboard-keys" id="keyboardKeys">
                        <!-- é‹¼ç´éµå°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- é‹¼ç´è¨­å®š -->
                <div class="piano-settings">
                    <div class="settings-group">
                        <label class="settings-label">ğŸ¶ å…«åº¦éŸ³éš</label>
                        <div class="octave-selector" id="octaveSelector">
                            <!-- å…«åº¦éŸ³éšæŒ‰éˆ•å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">ğŸšï¸ éˆæ•åº¦èª¿æ•´</label>
                        <div class="slider-container">
                            <input type="range" id="sensitivitySlider" min="1" max="10" step="0.5" value="5">
                            <span class="slider-value" id="sensitivityValue">5.0</span>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">ğŸµ éŸ³é‡æ§åˆ¶</label>
                        <div class="slider-container">
                            <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.5">
                            <span class="slider-value" id="volumeValue">0.5</span>
                        </div>
                    </div>
                </div>

                <!-- éŠæˆ²çµ±è¨ˆ -->
                <div class="game-stats">
                    <div class="stat-box">
                        <div class="stat-value" id="notesPlayed">0</div>
                        <div class="stat-label">å½ˆå¥éŸ³ç¬¦æ•¸</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="playTime">0</div>
                        <div class="stat-label">æ¼”å¥æ™‚é–“(ç§’)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="accuracy">100%</div>
                        <div class="stat-label">æ¼”å¥æº–ç¢ºç‡</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="currentOctave">4</div>
                        <div class="stat-label">ç•¶å‰å…«åº¦éŸ³</div>
                    </div>
                </div>

                <!-- æ¨‚è­œé¡¯ç¤º -->
                <div class="sheet-music">
                    <div class="sheet-title">ğŸ¼ ç•¶å‰æ¨‚æ›²</div>
                    <div class="note-sequence" id="currentSongDisplay">å°æ˜Ÿæ˜Ÿ</div>
                    <div class="note-sequence" id="noteSequence">C C G G A A G</div>
                </div>

                <!-- æ§åˆ¶é¢æ¿ -->
                <div class="control-panel">
                    <button class="control-btn primary" id="startBtn">
                        ğŸ® é–‹å§‹æ¼”å¥
                    </button>
                    <button class="control-btn secondary" id="recordBtn">
                        âºï¸ é–‹å§‹éŒ„éŸ³
                    </button>
                    <button class="control-btn secondary" id="playbackBtn">
                        â–¶ï¸ æ’­æ”¾éŒ„éŸ³
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨‚æ›²é¸æ“‡ -->
    <div class="song-selection">
        <div class="song-title">ğŸµ æ¨‚æ›²é¸æ“‡</div>
        <div class="song-list" id="songList">
            <!-- æ¨‚æ›²é¸æ“‡æŒ‰éˆ•å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
        </div>
    </div>

    <!-- æ‰‹å‹¢æç¤º -->
    <div class="gesture-hint">
        <div class="hint-title">âœ‹ æ‰‹å‹¢æ§åˆ¶</div>
        <div class="hint-list">
            <div class="hint-item">
                <div class="hint-icon">ğŸ‘†</div>
                <div class="hint-text">é£ŸæŒ‡ä¸‹å£“ï¼šå½ˆå¥ç™½éµ</div>
            </div>
            <div class="hint-item">
                <div class="hint-icon">ğŸ¤</div>
                <div class="hint-text">ä¸­æŒ‡ä¸‹å£“ï¼šå½ˆå¥é»‘éµ</div>
            </div>
            <div class="hint-item">
                <div class="hint-icon">ğŸ‘Œ</div>
                <div class="hint-text">æ‹‡æŒ‡å’Œé£ŸæŒ‡ï¼šèª¿æ•´å…«åº¦éŸ³</div>
            </div>
            <div class="hint-item">
                <div class="hint-icon">ğŸ¤²</div>
                <div class="hint-text">é›™æ‰‹å¹³æ”¾ï¼šåœæ­¢æ‰€æœ‰éŸ³</div>
            </div>
        </div>
    </div>

    <!-- æ¬Šé™æç¤º -->
    <div id="permissionPrompt" style="display: none;">
        <div class="prompt-content">
            <h2 class="prompt-title">éœ€è¦æ”å½±æ©Ÿæ¬Šé™</h2>
            <p class="prompt-message">
                ç‚ºäº†é€²è¡Œæ‰‹å‹¢è¾¨è­˜ï¼Œéœ€è¦å­˜å–æ‚¨çš„æ”å½±æ©Ÿã€‚<br>
                è«‹å…è¨±æ”å½±æ©Ÿæ¬Šé™ä»¥é–‹å§‹æ¼”å¥ã€‚
            </p>
            <button class="prompt-btn" id="retryPermissionBtn">å…è¨±æ”å½±æ©Ÿå­˜å–</button>
        </div>
    </div>

    <!-- è¼‰å…¥å¤–éƒ¨è…³æœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script>
        // ==================== éŠæˆ²è®Šæ•¸ ====================
        let cameraStream = null;
        let hands = null;
        let gameActive = false;
        let recording = false;
        let playback = false;
        
        // é‹¼ç´ç‹€æ…‹
        let currentOctave = 4;
        let sensitivity = 5.0;
        let volume = 0.5;
        let audioContext = null;
        let oscillators = {};
        
        // éŠæˆ²çµ±è¨ˆ
        let gameStats = {
            notesPlayed: 0,
            playTime: 0,
            correctNotes: 0,
            totalNotes: 0
        };
        
        // éŒ„éŸ³åŠŸèƒ½
        let recordingData = [];
        let recordedNotes = [];
        let playbackIndex = 0;
        let playbackInterval = null;
        
        // æ‰‹å‹¢ç‹€æ…‹
        let handDetected = false;
        let fingerPositions = {};
        let lastNoteTime = 0;
        let noteCooldown = 100; // æ¯«ç§’
        
        // æ¨‚æ›²è³‡æ–™
        let currentSong = null;
        let songProgress = 0;
        let songInterval = null;
        
        const PIANO_NOTES = [
            // ç™½éµ: C, D, E, F, G, A, B
            // é»‘éµ: C#, D#, F#, G#, A#
            'C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'
        ];
        
        const PIANO_SONGS = {
            'å°æ˜Ÿæ˜Ÿ': ['C', 'C', 'G', 'G', 'A', 'A', 'G', 'F', 'F', 'E', 'E', 'D', 'D', 'C'],
            'æ­¡æ¨‚é Œ': ['E', 'E', 'F', 'G', 'G', 'F', 'E', 'D', 'C', 'C', 'D', 'E', 'E', 'D', 'D'],
            'ç”Ÿæ—¥å¿«æ¨‚': ['C', 'C', 'D', 'C', 'F', 'E', 'C', 'C', 'D', 'C', 'G', 'F'],
            'å…©éš»è€è™': ['C', 'D', 'E', 'C', 'C', 'D', 'E', 'C', 'E', 'F', 'G', 'E', 'F', 'G'],
            'ç‘ªè‰æœ‰éš»å°ç¶¿ç¾Š': ['E', 'D', 'C', 'D', 'E', 'E', 'E', 'D', 'D', 'D', 'E', 'G', 'G']
        };
        
        // Canvas ç›¸é—œ
        let canvas, ctx;
        let animationFrameId = null;
        
        // é‹¼ç´éµè¦–è¦ºåŒ–
        let pianoKeys = [];
        let activeKeys = new Set();
        
        // DOMå…ƒç´ 
        const cameraFeed = document.getElementById('cameraFeed');
        const gameCanvas = document.getElementById('gameCanvas');
        const handStatusText = document.getElementById('handStatusText');
        const fingerInfo = document.getElementById('fingerInfo');
        const keyboardKeys = document.getElementById('keyboardKeys');
        const octaveSelector = document.getElementById('octaveSelector');
        const sensitivitySlider = document.getElementById('sensitivitySlider');
        const sensitivityValue = document.getElementById('sensitivityValue');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeValue = document.getElementById('volumeValue');
        const notesPlayedElement = document.getElementById('notesPlayed');
        const playTimeElement = document.getElementById('playTime');
        const accuracyElement = document.getElementById('accuracy');
        const currentOctaveElement = document.getElementById('currentOctave');
        const currentSongDisplay = document.getElementById('currentSongDisplay');
        const noteSequence = document.getElementById('noteSequence');
        const startBtn = document.getElementById('startBtn');
        const recordBtn = document.getElementById('recordBtn');
        const playbackBtn = document.getElementById('playbackBtn');
        const songList = document.getElementById('songList');
        const noteVisualizer = document.getElementById('noteVisualizer');
        const permissionPrompt = document.getElementById('permissionPrompt');
        const retryPermissionBtn = document.getElementById('retryPermissionBtn');
        const loadingScreen = document.getElementById('loadingScreen');
        
        // ==================== åˆå§‹åŒ– ====================
        async function init() {
            try {
                // åˆå§‹åŒ– Canvas
                initCanvas();
                
                // åˆå§‹åŒ– Web Audio API
                initAudio();
                
                // åˆå§‹åŒ–é‹¼ç´éµç›¤
                initPianoKeys();
                
                // åˆå§‹åŒ–å…«åº¦éŸ³é¸æ“‡å™¨
                initOctaveSelector();
                
                // åˆå§‹åŒ–æ¨‚æ›²é¸æ“‡
                initSongList();
                
                // åˆå§‹åŒ– MediaPipe Hands
                await initMediaPipe();
                
                // è¨­å®šäº‹ä»¶ç›£è½å™¨
                setupEventListeners();
                
                // é–‹å§‹éŠæˆ²å¾ªç’°
                gameLoop();
                
                // éš±è—è¼‰å…¥ç•«é¢
                setTimeout(() => {
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                    }, 500);
                }, 1000);
                
            } catch (error) {
                console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
                showPermissionPrompt();
            }
        }
        
        function initCanvas() {
            canvas = gameCanvas;
            ctx = canvas.getContext('2d');
            
            // è¨­å®š Canvas å¤§å°
            const container = document.querySelector('.camera-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            
            // è¦–çª—å¤§å°èª¿æ•´
            window.addEventListener('resize', () => {
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
            });
        }
        
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('Web Audio API åˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('Web Audio API åˆå§‹åŒ–å¤±æ•—:', error);
                alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ Web Audio APIï¼Œéƒ¨åˆ†éŸ³æ•ˆåŠŸèƒ½å¯èƒ½ç„¡æ³•ä½¿ç”¨ã€‚');
            }
        }
        
        // ==================== MediaPipe Hands åˆå§‹åŒ– ====================
        async function initMediaPipe() {
            return new Promise((resolve, reject) => {
                hands = new Hands({
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                    }
                });
        
                hands.setOptions({
                    maxNumHands: 2,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
        
                hands.onResults(onHandResults);
        
                // è«‹æ±‚æ”å½±æ©Ÿæ¬Šé™
                requestCameraAccess().then(resolve).catch(reject);
            });
        }
        
        async function requestCameraAccess() {
            try {
                const constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                };
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // è¨­å®šå½±ç‰‡ä¸²æµ
                cameraFeed.srcObject = cameraStream;
                
                // å•Ÿå‹•ç›¸æ©Ÿ
                const camera = new Camera(cameraFeed, {
                    onFrame: async () => {
                        if (hands) {
                            await hands.send({ image: cameraFeed });
                        }
                    },
                    width: 640,
                    height: 480
                });
                
                camera.start();
                
            } catch (error) {
                console.error('æ”å½±æ©Ÿå­˜å–éŒ¯èª¤:', error);
                showPermissionPrompt();
                throw error;
            }
        }
        
        // ==================== é‹¼ç´éµç›¤åˆå§‹åŒ– ====================
        function initPianoKeys() {
            keyboardKeys.innerHTML = '';
            pianoKeys = [];
            
            // ä¸€å€‹å…«åº¦éŸ³æœ‰12å€‹éµï¼ˆ7å€‹ç™½éµ + 5å€‹é»‘éµï¼‰
            const whiteKeys = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            const blackKeys = ['C#', 'D#', '', 'F#', 'G#', 'A#', ''];
            
            let whiteKeyIndex = 0;
            let blackKeyIndex = 0;
            
            for (let i = 0; i < 12; i++) {
                const noteName = PIANO_NOTES[i];
                const isBlackKey = noteName.includes('#');
                
                const keyElement = document.createElement('div');
                keyElement.className = `piano-key ${isBlackKey ? 'black-key' : 'white-key'}`;
                keyElement.dataset.note = noteName;
                keyElement.dataset.index = i;
                
                if (isBlackKey) {
                    // é»‘éµä½ç½®åœ¨ç™½éµä¹‹é–“
                    const leftPosition = (blackKeyIndex * 40 + 25) + 'px';
                    keyElement.style.left = leftPosition;
                    blackKeyIndex++;
                } else {
                    // ç™½éµ
                    whiteKeyIndex++;
                }
                
                keyboardKeys.appendChild(keyElement);
                
                pianoKeys.push({
                    element: keyElement,
                    note: noteName,
                    isBlack: isBlackKey,
                    isActive: false
                });
            }
        }
        
        function initOctaveSelector() {
            octaveSelector.innerHTML = '';
            
            // 3-6å…«åº¦éŸ³
            for (let octave = 3; octave <= 6; octave++) {
                const btn = document.createElement('button');
                btn.className = `octave-btn ${octave === 4 ? 'active' : ''}`;
                btn.textContent = octave.toString();
                btn.dataset.octave = octave;
                
                btn.addEventListener('click', () => {
                    changeOctave(octave);
                });
                
                octaveSelector.appendChild(btn);
            }
        }
        
        function initSongList() {
            songList.innerHTML = '';
            
            Object.keys(PIANO_SONGS).forEach(songName => {
                const btn = document.createElement('button');
                btn.className = 'song-btn';
                btn.textContent = songName;
                btn.dataset.song = songName;
                
                btn.addEventListener('click', () => {
                    selectSong(songName);
                });
                
                songList.appendChild(btn);
            });
        }
        
        // ==================== æ‰‹å‹¢çµæœè™•ç† ====================
        function onHandResults(results) {
            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                handDetected = false;
                handStatusText.textContent = "ç­‰å¾…æ‰‹éƒ¨...";
                return;
            }
        
            handDetected = true;
            handStatusText.textContent = "æ‰‹éƒ¨å·²åµæ¸¬";
            
            // æ¸…é™¤ä¹‹å‰çš„æŒ‡å°–ä½ç½®
            fingerPositions = {};
            
            // è™•ç†æ¯éš»æ‰‹
            results.multiHandLandmarks.forEach((landmarks, handIndex) => {
                // è¿½è¹¤æŒ‡å°–ä½ç½®
                const fingerTips = {
                    thumb: landmarks[4],
                    index: landmarks[8],
                    middle: landmarks[12],
                    ring: landmarks[16],
                    pinky: landmarks[20]
                };
                
                // è½‰æ›ç‚ºç•«å¸ƒåº§æ¨™
                Object.keys(fingerTips).forEach(finger => {
                    const tip = fingerTips[finger];
                    fingerPositions[`hand${handIndex}_${finger}`] = {
                        x: tip.x * canvas.width,
                        y: tip.y * canvas.height,
                        z: tip.z
                    };
                });
                
                // æª¢æŸ¥æ‰‹å‹¢ä¸¦å½ˆå¥éŸ³ç¬¦
                if (gameActive) {
                    detectAndPlayNotes(landmarks, handIndex);
                }
            });
            
            updateFingerInfo();
        }
        
        function detectAndPlayNotes(landmarks, handIndex) {
            const now = Date.now();
            if (now - lastNoteTime < noteCooldown) return;
            
            // æª¢æŸ¥æ¯å€‹æŒ‡å°–æ˜¯å¦åœ¨æŒ‰å£“ä½ç½®
            const fingerIndices = [
                { finger: 'index', keyType: 'white' },
                { finger: 'middle', keyType: 'black' },
                { finger: 'thumb', keyType: 'special' }
            ];
            
            fingerIndices.forEach(({ finger, keyType }) => {
                const tipIndex = finger === 'thumb' ? 4 : 
                               finger === 'index' ? 8 :
                               finger === 'middle' ? 12 : 8;
                
                const tip = landmarks[tipIndex];
                const mcp = landmarks[tipIndex - 3]; // æ‰‹æŒ‡æ ¹éƒ¨é—œç¯€
                
                // è¨ˆç®—æŒ‡å°–èˆ‡æ ¹éƒ¨çš„è·é›¢ï¼ˆæŒ‰å£“æ·±åº¦ï¼‰
                const pressDepth = tip.y - mcp.y;
                
                // æ ¹æ“šéˆæ•åº¦èª¿æ•´é–¾å€¼
                const pressThreshold = 0.02 + (0.05 / sensitivity);
                
                if (pressDepth > pressThreshold) {
                    // æ‰‹æŒ‡åœ¨æŒ‰å£“ç‹€æ…‹
                    const fingerKey = `hand${handIndex}_${finger}`;
                    const pos = fingerPositions[fingerKey];
                    
                    if (pos) {
                        // æ ¹æ“šæ‰‹æŒ‡ä½ç½®ç¢ºå®šè¦å½ˆå¥çš„éµ
                        let noteIndex = Math.floor((pos.x / canvas.width) * 12);
                        noteIndex = Math.max(0, Math.min(11, noteIndex));
                        
                        const noteName = PIANO_NOTES[noteIndex];
                        
                        // æª¢æŸ¥æ˜¯å¦ç‚ºæ­£ç¢ºçš„éµé¡å‹
                        const isBlackKey = noteName.includes('#');
                        const shouldPlay = (keyType === 'white' && !isBlackKey) || 
                                          (keyType === 'black' && isBlackKey) ||
                                          (keyType === 'special');
                        
                        if (shouldPlay) {
                            playNote(noteName, currentOctave);
                            activatePianoKey(noteIndex);
                            lastNoteTime = now;
                            
                            // å¦‚æœæ˜¯éŒ„éŸ³æ¨¡å¼ï¼Œè¨˜éŒ„éŸ³ç¬¦
                            if (recording) {
                                recordNote(noteName, currentOctave, now);
                            }
                        }
                    }
                }
            });
            
            // æª¢æŸ¥æ‹‡æŒ‡å’Œé£ŸæŒ‡çš„æåˆæ‰‹å‹¢ï¼ˆèª¿æ•´å…«åº¦éŸ³ï¼‰
            const thumbTip = landmarks[4];
            const indexTip = landmarks[8];
            const distance = Math.sqrt(
                Math.pow(thumbTip.x - indexTip.x, 2) +
                Math.pow(thumbTip.y - indexTip.y, 2)
            );
            
            if (distance < 0.05) {
                // æåˆæ‰‹å‹¢ - èª¿æ•´å…«åº¦éŸ³
                const octaveChange = thumbTip.y < indexTip.y ? 1 : -1;
                const newOctave = Math.max(3, Math.min(6, currentOctave + octaveChange));
                
                if (newOctave !== currentOctave) {
                    changeOctave(newOctave);
                    lastNoteTime = now + 500; // é˜²æ­¢é€£çºŒè§¸ç™¼
                }
            }
            
            // æª¢æŸ¥æ˜¯å¦é›™æ‰‹å¹³æ”¾ï¼ˆåœæ­¢æ‰€æœ‰éŸ³ï¼‰
            const handsFlat = checkHandsFlat(landmarks);
            if (handsFlat) {
                stopAllNotes();
            }
        }
        
        function checkHandsFlat(landmarks) {
            // ç°¡å–®æª¢æŸ¥ï¼šæ‰€æœ‰æŒ‡å°–éƒ½åœ¨ç›¸ä¼¼çš„é«˜åº¦
            const tips = [4, 8, 12, 16, 20];
            const tipYs = tips.map(index => landmarks[index].y);
            const maxY = Math.max(...tipYs);
            const minY = Math.min(...tipYs);
            
            return (maxY - minY) < 0.05; // æŒ‡å°–é«˜åº¦å·®å¾ˆå°
        }
        
        function updateFingerInfo() {
            if (!handDetected) {
                fingerInfo.textContent = "ä½¿ç”¨é£ŸæŒ‡å½ˆå¥é‹¼ç´éµ";
                return;
            }
            
            const info = [];
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æŒ‡å°–åœ¨æŒ‰å£“ä½ç½®
            Object.keys(fingerPositions).forEach(key => {
                if (key.includes('index')) {
                    info.push("é£ŸæŒ‡: æº–å‚™å½ˆå¥");
                } else if (key.includes('middle')) {
                    info.push("ä¸­æŒ‡: é»‘éµæ§åˆ¶");
                }
            });
            
            fingerInfo.textContent = info.length > 0 ? info.join(" | ") : "ç§»å‹•æ‰‹æŒ‡å½ˆå¥é‹¼ç´";
        }
        
        // ==================== éŸ³æ•ˆè™•ç† ====================
        function playNote(noteName, octave) {
            if (!audioContext) return;
            
            // è¨ˆç®—é »ç‡
            const frequency = getNoteFrequency(noteName, octave);
            
            // åœæ­¢ç›¸åŒéŸ³ç¬¦çš„ç¾æœ‰æŒ¯ç›ªå™¨
            const noteKey = `${noteName}${octave}`;
            if (oscillators[noteKey]) {
                oscillators[noteKey].stop();
                delete oscillators[noteKey];
            }
            
            // å‰µå»ºæŒ¯ç›ªå™¨
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // è¨­å®šæ³¢å½¢å’Œé »ç‡
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            
            // è¨­å®šéŸ³é‡
            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
            
            // æ·¡å…¥æ•ˆæœ
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 2);
            
            // é–‹å§‹æ’­æ”¾
            oscillator.start();
            
            // å„²å­˜æŒ¯ç›ªå™¨ä»¥ä¾¿åœæ­¢
            oscillators[noteKey] = {
                oscillator: oscillator,
                gainNode: gainNode,
                stopTime: audioContext.currentTime + 2
            };
            
            // æ›´æ–°çµ±è¨ˆ
            gameStats.notesPlayed++;
            gameStats.totalNotes++;
            
            // è¦–è¦ºåŒ–æ•ˆæœ
            createNoteVisualization(noteName);
            
            // æ›´æ–°é¡¯ç¤º
            updateStats();
        }
        
        function getNoteFrequency(noteName, octave) {
            // A4 = 440Hz
            const noteIndex = PIANO_NOTES.indexOf(noteName);
            const semitonesFromA4 = (octave - 4) * 12 + (noteIndex - 9); // A = index 9
            
            return 440 * Math.pow(2, semitonesFromA4 / 12);
        }
        
        function stopAllNotes() {
            Object.values(oscillators).forEach(({ oscillator, gainNode }) => {
                try {
                    gainNode.gain.cancelScheduledValues(audioContext.currentTime);
                    gainNode.gain.setValueAtTime(gainNode.gain.value, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);
                    
                    setTimeout(() => {
                        oscillator.stop();
                    }, 100);
                } catch (e) {
                    console.error('åœæ­¢éŸ³æ•ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
                }
            });
            
            oscillators = {};
            
            // åœç”¨æ‰€æœ‰é‹¼ç´éµ
            deactivateAllKeys();
        }
        
        // ==================== é‹¼ç´éµè¦–è¦ºåŒ– ====================
        function activatePianoKey(keyIndex) {
            if (keyIndex < 0 || keyIndex >= pianoKeys.length) return;
            
            const key = pianoKeys[keyIndex];
            key.isActive = true;
            key.element.classList.add('active');
            
            // è‡ªå‹•åœç”¨
            setTimeout(() => {
                deactivatePianoKey(keyIndex);
            }, 300);
        }
        
        function deactivatePianoKey(keyIndex) {
            if (keyIndex < 0 || keyIndex >= pianoKeys.length) return;
            
            const key = pianoKeys[keyIndex];
            key.isActive = false;
            key.element.classList.remove('active');
        }
        
        function deactivateAllKeys() {
            pianoKeys.forEach((key, index) => {
                deactivatePianoKey(index);
            });
        }
        
        // ==================== éŸ³ç¬¦è¦–è¦ºåŒ– ====================
        function createNoteVisualization(noteName) {
            const noteEmojis = {
                'C': 'ğŸµ', 'C#': 'ğŸ¶', 'D': 'â™ª', 'D#': 'â™«', 'E': 'ğŸ¶',
                'F': 'ğŸµ', 'F#': 'ğŸ¶', 'G': 'â™ª', 'G#': 'â™«', 'A': 'ğŸ¶', 'A#': 'â™¬', 'B': 'ğŸµ'
            };
            
            const noteEmoji = noteEmojis[noteName] || 'ğŸµ';
            
            // éš¨æ©Ÿä½ç½®
            const x = Math.random() * canvas.width;
            const y = canvas.height;
            
            const noteElement = document.createElement('div');
            noteElement.className = 'note-particle';
            noteElement.textContent = noteEmoji;
            noteElement.style.left = `${x}px`;
            noteElement.style.top = `${y}px`;
            noteElement.style.color = getNoteColor(noteName);
            
            noteVisualizer.appendChild(noteElement);
            
            // ç§»é™¤å‹•ç•«çµæŸçš„å…ƒç´ 
            setTimeout(() => {
                if (noteElement.parentNode === noteVisualizer) {
                    noteVisualizer.removeChild(noteElement);
                }
            }, 3000);
        }
        
        function getNoteColor(noteName) {
            const colors = {
                'C': '#FF6B6B', 'C#': '#4ECDC4', 'D': '#FFD166', 'D#': '#06D6A0',
                'E': '#118AB2', 'F': '#EF476F', 'F#': '#FFD166', 'G': '#073B4C',
                'G#': '#7209B7', 'A': '#3A86FF', 'A#': '#8338EC', 'B': '#FF006E'
            };
            return colors[noteName] || '#FFFFFF';
        }
        
        // ==================== éŠæˆ²æ§åˆ¶ ====================
        function startGame() {
            gameActive = !gameActive;
            
            if (gameActive) {
                startBtn.textContent = "â¸ï¸ æš«åœæ¼”å¥";
                startBtn.classList.add('secondary');
                startBtn.classList.remove('primary');
            } else {
                startBtn.textContent = "ğŸ® é–‹å§‹æ¼”å¥";
                startBtn.classList.add('primary');
                startBtn.classList.remove('secondary');
                stopAllNotes();
            }
            
            updateGameStatus();
        }
        
        function startRecording() {
            recording = !recording;
            
            if (recording) {
                recordingData = [];
                recordedNotes = [];
                recordBtn.textContent = "â¹ï¸ åœæ­¢éŒ„éŸ³";
                recordBtn.classList.add('primary');
                recordBtn.classList.remove('secondary');
            } else {
                recordBtn.textContent = "âºï¸ é–‹å§‹éŒ„éŸ³";
                recordBtn.classList.add('secondary');
                recordBtn.classList.remove('primary');
                
                if (recordedNotes.length > 0) {
                    alert(`éŒ„éŸ³å®Œæˆï¼å…±éŒ„è£½äº† ${recordedNotes.length} å€‹éŸ³ç¬¦ã€‚`);
                }
            }
        }
        
        function startPlayback() {
            if (recordedNotes.length === 0) {
                alert('æ²’æœ‰éŒ„éŸ³å¯ä»¥æ’­æ”¾ï¼è«‹å…ˆéŒ„è£½ä¸€äº›éŸ³ç¬¦ã€‚');
                return;
            }
            
            playback = !playback;
            
            if (playback) {
                playbackBtn.textContent = "â¹ï¸ åœæ­¢æ’­æ”¾";
                playbackBtn.classList.add('primary');
                playbackBtn.classList.remove('secondary');
                playbackIndex = 0;
                playRecordedNotes();
            } else {
                playbackBtn.textContent = "â–¶ï¸ æ’­æ”¾éŒ„éŸ³";
                playbackBtn.classList.add('secondary');
                playbackBtn.classList.remove('primary');
                stopPlayback();
            }
        }
        
        function playRecordedNotes() {
            if (!playback || playbackIndex >= recordedNotes.length) {
                playback = false;
                playbackBtn.textContent = "â–¶ï¸ æ’­æ”¾éŒ„éŸ³";
                playbackBtn.classList.add('secondary');
                playbackBtn.classList.remove('primary');
                return;
            }
            
            const note = recordedNotes[playbackIndex];
            playNote(note.note, note.octave);
            
            playbackIndex++;
            
            if (playbackIndex < recordedNotes.length) {
                const nextNote = recordedNotes[playbackIndex];
                const delay = nextNote.time - note.time;
                
                playbackInterval = setTimeout(playRecordedNotes, delay);
            } else {
                playback = false;
                playbackBtn.textContent = "â–¶ï¸ æ’­æ”¾éŒ„éŸ³";
                playbackBtn.classList.add('secondary');
                playbackBtn.classList.remove('primary');
            }
        }
        
        function stopPlayback() {
            if (playbackInterval) {
                clearTimeout(playbackInterval);
                playbackInterval = null;
            }
            playback = false;
            stopAllNotes();
        }
        
        function recordNote(noteName, octave, time) {
            recordedNotes.push({
                note: noteName,
                octave: octave,
                time: time
            });
        }
        
        // ==================== æ¨‚æ›²åŠŸèƒ½ ====================
        function selectSong(songName) {
            currentSong = songName;
            
            // æ›´æ–°æ­Œæ›²é¸æ“‡æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.song-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.song === songName) {
                    btn.classList.add('active');
                }
            });
            
            // æ›´æ–°é¡¯ç¤º
            currentSongDisplay.textContent = songName;
            noteSequence.textContent = PIANO_SONGS[songName].join(' ');
            
            // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œé‡æ–°é–‹å§‹
            if (songInterval) {
                clearInterval(songInterval);
                startSongPlayback();
            }
        }
        
        function startSongPlayback() {
            if (!currentSong) return;
            
            songProgress = 0;
            const songNotes = PIANO_SONGS[currentSong];
            
            songInterval = setInterval(() => {
                if (songProgress >= songNotes.length) {
                    clearInterval(songInterval);
                    return;
                }
                
                const note = songNotes[songProgress];
                playNote(note, currentOctave);
                
                // æ›´æ–°æ¨‚è­œé¡¯ç¤º
                updateSheetMusicDisplay(songProgress);
                
                songProgress++;
            }, 500); // æ¯åŠç§’ä¸€å€‹éŸ³ç¬¦
        }
        
        function updateSheetMusicDisplay(currentIndex) {
            const notes = PIANO_SONGS[currentSong];
            const displayNotes = notes.map((note, index) => {
                if (index === currentIndex) {
                    return `<span class="current">${note}</span>`;
                }
                return note;
            }).join(' ');
            
            noteSequence.innerHTML = displayNotes;
        }
        
        // ==================== è¨­å®šè®Šæ›´ ====================
        function changeOctave(newOctave) {
            currentOctave = newOctave;
            currentOctaveElement.textContent = currentOctave;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.octave-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.octave) === newOctave) {
                    btn.classList.add('active');
                }
            });
        }
        
        // ==================== éŠæˆ²å¾ªç’° ====================
        function gameLoop() {
            if (gameActive) {
                gameStats.playTime += 0.016; // å¤§ç´„60fps
                updateStats();
            }
            
            drawGame();
            animationFrameId = requestAnimationFrame(gameLoop);
        }
        
        function drawGame() {
            // æ¸…é™¤ç•«å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!handDetected || !gameActive) return;
            
            // ç¹ªè£½æŒ‡å°–ä½ç½®
            Object.keys(fingerPositions).forEach(key => {
                const pos = fingerPositions[key];
                
                // ä¸åŒæ‰‹æŒ‡ä¸åŒé¡è‰²
                let color = '#FFFFFF';
                let radius = 10;
                
                if (key.includes('thumb')) {
                    color = '#FF6B6B';
                    radius = 12;
                } else if (key.includes('index')) {
                    color = '#4ECDC4';
                    radius = 15;
                } else if (key.includes('middle')) {
                    color = '#FFD166';
                    radius = 15;
                } else if (key.includes('ring')) {
                    color = '#06D6A0';
                } else if (key.includes('pinky')) {
                    color = '#118AB2';
                }
                
                // ç¹ªè£½æŒ‡å°–åœ“åœˆ
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, radius, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = '#FFFFFF';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // ç¹ªè£½æ‰‹æŒ‡æ¨™ç±¤
                ctx.font = '12px Arial';
                ctx.fillStyle = '#FFFFFF';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const fingerName = key.split('_')[1];
                ctx.fillText(fingerName.charAt(0).toUpperCase(), pos.x, pos.y - radius - 10);
            });
            
            // ç¹ªè£½é‹¼ç´éµç›¤ä½ç½®æç¤º
            drawPianoGuide();
        }
        
        function drawPianoGuide() {
            const keyWidth = canvas.width / 12;
            
            for (let i = 0; i < 12; i++) {
                const x = i * keyWidth;
                const isBlackKey = PIANO_NOTES[i].includes('#');
                
                ctx.beginPath();
                ctx.rect(x, canvas.height - 50, keyWidth, 50);
                ctx.fillStyle = isBlackKey ? 'rgba(0, 0, 0, 0.3)' : 'rgba(255, 255, 255, 0.1)';
                ctx.fill();
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // é¡¯ç¤ºéŸ³ç¬¦åç¨±
                ctx.font = '14px Arial';
                ctx.fillStyle = '#FFFFFF';
                ctx.textAlign = 'center';
                ctx.fillText(PIANO_NOTES[i], x + keyWidth / 2, canvas.height - 20);
            }
        }
        
        // ==================== æ›´æ–°é¡¯ç¤º ====================
        function updateStats() {
            notesPlayedElement.textContent = gameStats.notesPlayed;
            playTimeElement.textContent = Math.round(gameStats.playTime);
            
            if (gameStats.totalNotes > 0) {
                const accuracy = Math.round((gameStats.correctNotes / gameStats.totalNotes) * 100);
                accuracyElement.textContent = `${accuracy}%`;
            }
        }
        
        function updateGameStatus() {
            const statusText = gameActive ? 'æ¼”å¥ä¸­' : 'æš«åœä¸­';
            const statusColor = gameActive ? '#4CAF50' : '#FF9800';
            
            // å¯ä»¥æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨
        }
        
        // ==================== äº‹ä»¶ç›£è½å™¨ ====================
        function setupEventListeners() {
            startBtn.addEventListener('click', startGame);
            recordBtn.addEventListener('click', startRecording);
            playbackBtn.addEventListener('click', startPlayback);
            retryPermissionBtn.addEventListener('click', retryCameraAccess);
            
            // éˆæ•åº¦æ»‘æ¡¿
            sensitivitySlider.addEventListener('input', () => {
                sensitivity = parseFloat(sensitivitySlider.value);
                sensitivityValue.textContent = sensitivity.toFixed(1);
            });
            
            // éŸ³é‡æ»‘æ¡¿
            volumeSlider.addEventListener('input', () => {
                volume = parseFloat(volumeSlider.value);
                volumeValue.textContent = volume.toFixed(1);
            });
            
            // è¦–çª—å¤§å°èª¿æ•´
            window.addEventListener('resize', () => {
                const container = document.querySelector('.camera-container');
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
            });
            
            // éµç›¤æ§åˆ¶ï¼ˆè¼”åŠ©åŠŸèƒ½ï¼‰
            document.addEventListener('keydown', (e) => {
                if (!gameActive) return;
                
                const keyMap = {
                    'a': 'C', 'w': 'C#', 's': 'D', 'e': 'D#', 'd': 'E',
                    'f': 'F', 't': 'F#', 'g': 'G', 'y': 'G#', 'h': 'A',
                    'u': 'A#', 'j': 'B'
                };
                
                if (keyMap[e.key]) {
                    playNote(keyMap[e.key], currentOctave);
                    
                    const noteIndex = PIANO_NOTES.indexOf(keyMap[e.key]);
                    if (noteIndex !== -1) {
                        activatePianoKey(noteIndex);
                    }
                }
                
                // å…«åº¦éŸ³æ§åˆ¶
                if (e.key === 'ArrowUp') {
                    changeOctave(Math.min(6, currentOctave + 1));
                } else if (e.key === 'ArrowDown') {
                    changeOctave(Math.max(3, currentOctave - 1));
                }
            });
        }
        
        function showPermissionPrompt() {
            permissionPrompt.style.display = 'flex';
            loadingScreen.style.display = 'none';
        }
        
        async function retryCameraAccess() {
            permissionPrompt.style.display = 'none';
            
            try {
                await requestCameraAccess();
            } catch (error) {
                showPermissionPrompt();
            }
        }
        
        // ==================== å•Ÿå‹•éŠæˆ² ====================
        // ç­‰å¾…é é¢è¼‰å…¥å®Œæˆ
        window.addEventListener('load', init);
        
        // è™•ç†é é¢å¸è¼‰
        window.addEventListener('beforeunload', () => {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            if (songInterval) {
                clearInterval(songInterval);
            }
            stopAllNotes();
            stopPlayback();
        });
    </script>
</body>
</html>