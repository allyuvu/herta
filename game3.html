<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²“å’ªé«”æ„ŸéŠæˆ²ï¼šæ‰‹å‹¢æŠ“é€—è²“æ£’</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* æ¨™é¡Œå€ */
        .header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 20px;
        }

        .game-title {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #FF9A9E, #FAD0C4, #FAD0C4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(255, 154, 158, 0.3);
            letter-spacing: 1px;
        }

        .cat-emoji {
            font-size: 4rem;
            margin-bottom: 10px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .subtitle {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.8);
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* ä¸»éŠæˆ²å€ */
        .main-game {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 20px;
        }

        /* ç›¸æ©Ÿå’ŒéŠæˆ²å€åŸŸ */
        .camera-game-container {
            flex: 2;
            min-width: 300px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            overflow: hidden;
            border: 4px solid rgba(255, 154, 158, 0.3);
            backdrop-filter: blur(10px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            position: relative;
        }

        .camera-feed {
            width: 100%;
            height: 500px;
            object-fit: cover;
            display: block;
            background: #000;
        }

        /* éŠæˆ²ç•«å¸ƒ */
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 500px;
            z-index: 2;
            pointer-events: none;
        }

        /* æ‰‹éƒ¨æŒ‡ç¤ºå™¨ */
        .hand-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 15px;
            border: 2px solid rgba(255, 154, 158, 0.5);
            z-index: 3;
            backdrop-filter: blur(10px);
            min-width: 200px;
        }

        .hand-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .hand-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #FF9A9E;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .hand-text {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .hand-position {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* éŠæˆ²è³‡è¨Šé¢æ¿ */
        .game-info-panel {
            flex: 1;
            min-width: 300px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            padding: 30px;
            border: 4px solid rgba(251, 211, 141, 0.3);
            backdrop-filter: blur(10px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
        }

        .panel-title {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: #FAD0C4;
            text-align: center;
            border-bottom: 2px solid rgba(250, 208, 196, 0.3);
            padding-bottom: 15px;
        }

        /* è²“å’ªç‹€æ…‹ */
        .cat-status {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
        }

        .cat-avatar {
            font-size: 4rem;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .cat-details {
            flex: 1;
        }

        .cat-name {
            font-size: 1.8rem;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
        }

        .cat-mood {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
        }

        /* ç‹€æ…‹æ¢ */
        .status-bars {
            margin-bottom: 30px;
        }

        .status-item {
            margin-bottom: 20px;
        }

        .status-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .status-bar {
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .status-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .happiness-fill {
            background: linear-gradient(90deg, #FF9A9E, #FAD0C4);
            width: 80%;
        }

        .energy-fill {
            background: linear-gradient(90deg, #a8edea, #fed6e3);
            width: 60%;
        }

        .hunger-fill {
            background: linear-gradient(90deg, #ffecd2, #fcb69f);
            width: 40%;
        }

        /* éŠæˆ²çµ±è¨ˆ */
        .game-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 154, 158, 0.3);
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #FF9A9E;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: auto;
        }

        .control-btn {
            padding: 18px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-btn.primary {
            background: linear-gradient(45deg, #FF9A9E, #FAD0C4);
            color: #000;
            box-shadow: 0 5px 15px rgba(255, 154, 158, 0.4);
        }

        .control-btn.primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 154, 158, 0.6);
        }

        .control-btn.secondary {
            background: linear-gradient(45deg, #a8edea, #fed6e3);
            color: #000;
            box-shadow: 0 5px 15px rgba(168, 237, 234, 0.4);
        }

        .control-btn.secondary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(168, 237, 234, 0.6);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* éŠæˆ²æ—¥èªŒ */
        .game-log {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            max-height: 200px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(251, 211, 141, 0.3);
            backdrop-filter: blur(10px);
            z-index: 100;
            overflow-y: auto;
        }

        .log-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #FBD38D;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .log-content {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }

        .log-time {
            color: #FF9A9E;
            font-size: 0.8rem;
            margin-right: 10px;
        }

        /* æ‰‹å‹¢æç¤º */
        .gesture-hint {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 300px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(255, 154, 158, 0.3);
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .hint-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #FF9A9E;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hint-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .hint-item {
            display: flex;
            align-items: center;
            gap: 12px;
            color: rgba(255, 255, 255, 0.8);
        }

        .hint-icon {
            font-size: 1.5rem;
            width: 30px;
            text-align: center;
        }

        .hint-text {
            font-size: 0.9rem;
        }

        /* æ¬Šé™æç¤º */
        #permissionPrompt {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .prompt-content {
            background: linear-gradient(135deg, #FF9A9E, #FAD0C4);
            padding: 50px;
            border-radius: 25px;
            text-align: center;
            max-width: 600px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .prompt-title {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #000;
        }

        .prompt-message {
            font-size: 1.2rem;
            margin-bottom: 30px;
            line-height: 1.6;
            color: rgba(0, 0, 0, 0.8);
        }

        .prompt-btn {
            background: #000;
            color: white;
            border: none;
            padding: 18px 50px;
            font-size: 1.3rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .prompt-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        /* è¼‰å…¥ç•«é¢ */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loader {
            width: 80px;
            height: 80px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top-color: #FF9A9E;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 30px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.5rem;
            color: white;
            letter-spacing: 2px;
        }

        /* è²“å’ªå‹•ç•«å€ */
        .cat-animation-area {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 200px;
            z-index: 1;
            pointer-events: none;
        }

        /* è‡ªè¨‚æ»¾å‹•æ¢ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 154, 158, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 154, 158, 0.7);
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 1200px) {
            .main-game {
                flex-direction: column;
            }
            
            .camera-game-container,
            .game-info-panel {
                width: 100%;
            }
            
            .game-title {
                font-size: 2.5rem;
            }
            
            .cat-emoji {
                font-size: 3rem;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 15px 0;
            }
            
            .game-title {
                font-size: 2rem;
            }
            
            .subtitle {
                font-size: 1rem;
                padding: 0 10px;
            }
            
            .camera-feed {
                height: 400px;
            }
            
            #gameCanvas {
                height: 400px;
            }
            
            .game-log,
            .gesture-hint {
                width: calc(100% - 40px);
                left: 20px;
                right: 20px;
            }
            
            .game-log {
                bottom: 240px;
            }
            
            .gesture-hint {
                bottom: 20px;
            }
        }

        @media (max-width: 480px) {
            .game-title {
                font-size: 1.8rem;
            }
            
            .cat-emoji {
                font-size: 2.5rem;
            }
            
            .camera-feed {
                height: 300px;
            }
            
            #gameCanvas {
                height: 300px;
            }
            
            .game-stats {
                grid-template-columns: 1fr;
            }
            
            .cat-avatar {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    <!-- è¼‰å…¥ç•«é¢ -->
    <div id="loadingScreen">
        <div class="loader"></div>
        <div class="loading-text">è¼‰å…¥éŠæˆ²ä¸­...</div>
    </div>

    <!-- è²“å’ªå‹•ç•«å€ -->
    <div class="cat-animation-area"></div>

    <div class="container">
        <!-- æ¨™é¡Œå€ -->
        <header class="header">
            <div class="cat-emoji">ğŸ±</div>
            <h1 class="game-title">è²“å’ªé«”æ„ŸéŠæˆ²</h1>
            <p class="subtitle">ä½¿ç”¨æ‰‹å‹¢èˆ‡å¯æ„›çš„è²“å’ªäº’å‹•ï¼æ®å‹•ä½ çš„æ‰‹ç§»å‹•é€—è²“æ£’ï¼Œè®“è²“å’ªé–‹å¿ƒç©è€ï¼</p>
        </header>

        <!-- ä¸»éŠæˆ²å€ -->
        <div class="main-game">
            <!-- ç›¸æ©Ÿå’ŒéŠæˆ²å€åŸŸ -->
            <div class="camera-game-container">
                <video class="camera-feed" id="cameraFeed"></video>
                <canvas id="gameCanvas"></canvas>
                
                <!-- æ‰‹éƒ¨æŒ‡ç¤ºå™¨ -->
                <div class="hand-indicator">
                    <div class="hand-status">
                        <div class="hand-dot"></div>
                        <div class="hand-text" id="handStatusText">åµæ¸¬æ‰‹éƒ¨ä¸­...</div>
                    </div>
                    <div class="hand-position" id="handPosition">X: --, Y: --</div>
                </div>
            </div>

            <!-- éŠæˆ²è³‡è¨Šé¢æ¿ -->
            <div class="game-info-panel">
                <h2 class="panel-title">ğŸ¾ è²“å’ªç‹€æ…‹</h2>
                
                <!-- è²“å’ªç‹€æ…‹ -->
                <div class="cat-status">
                    <div class="cat-avatar" id="catAvatar">ğŸ˜º</div>
                    <div class="cat-details">
                        <div class="cat-name" id="catName">æ©˜æ©˜</div>
                        <div class="cat-mood" id="catMood">å¿ƒæƒ…ï¼šé–‹å¿ƒ</div>
                    </div>
                </div>

                <!-- ç‹€æ…‹æ¢ -->
                <div class="status-bars">
                    <div class="status-item">
                        <div class="status-label">
                            <span>é–‹å¿ƒç¨‹åº¦</span>
                            <span id="happinessValue">80%</span>
                        </div>
                        <div class="status-bar">
                            <div class="status-fill happiness-fill" id="happinessBar"></div>
                        </div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label">
                            <span>æ´»åŠ›å€¼</span>
                            <span id="energyValue">60%</span>
                        </div>
                        <div class="status-bar">
                            <div class="status-fill energy-fill" id="energyBar"></div>
                        </div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label">
                            <span>é£¢é¤“åº¦</span>
                            <span id="hungerValue">40%</span>
                        </div>
                        <div class="status-bar">
                            <div class="status-fill hunger-fill" id="hungerBar"></div>
                        </div>
                    </div>
                </div>

                <!-- éŠæˆ²çµ±è¨ˆ -->
                <div class="game-stats">
                    <div class="stat-box">
                        <div class="stat-value" id="playTime">0</div>
                        <div class="stat-label">ç©è€æ™‚é–“(ç§’)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="catchCount">0</div>
                        <div class="stat-label">æŠ“åˆ°æ¬¡æ•¸</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="score">0</div>
                        <div class="stat-label">éŠæˆ²åˆ†æ•¸</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="combo">0</div>
                        <div class="stat-label">é€£çºŒæŠ“åˆ°</div>
                    </div>
                </div>

                <!-- æ§åˆ¶é¢æ¿ -->
                <div class="control-panel">
                    <button class="control-btn primary" id="startBtn">
                        ğŸ® é–‹å§‹éŠæˆ²
                    </button>
                    <button class="control-btn secondary" id="resetBtn">
                        ğŸ”„ é‡æ–°é–‹å§‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- éŠæˆ²æ—¥èªŒ -->
    <div class="game-log">
        <div class="log-title">ğŸ“œ éŠæˆ²æ—¥èªŒ</div>
        <div class="log-content" id="gameLog">
            <div class="log-entry">
                <span class="log-time">[ç³»çµ±]</span>
                æ­¡è¿ä¾†åˆ°è²“å’ªé«”æ„ŸéŠæˆ²ï¼
            </div>
        </div>
    </div>

    <!-- æ‰‹å‹¢æç¤º -->
    <div class="gesture-hint">
        <div class="hint-title">âœ‹ æ‰‹å‹¢æ§åˆ¶</div>
        <div class="hint-list">
            <div class="hint-item">
                <div class="hint-icon">ğŸ‘†</div>
                <div class="hint-text">é£ŸæŒ‡å‘ä¸Šï¼šå¬å–šé€—è²“æ£’</div>
            </div>
            <div class="hint-item">
                <div class="hint-icon">ğŸ¤</div>
                <div class="hint-text">æåˆæ‰‹å‹¢ï¼šæŠ“ä½é€—è²“æ£’</div>
            </div>
            <div class="hint-item">
                <div class="hint-icon">ğŸ‘‹</div>
                <div class="hint-text">æ®å‹•æ‰‹æŒï¼šç§»å‹•é€—è²“æ£’</div>
            </div>
            <div class="hint-item">
                <div class="hint-icon">âœŠ</div>
                <div class="hint-text">æ¡æ‹³ï¼šæŠ•é¤µé›¶é£Ÿ</div>
            </div>
        </div>
    </div>

    <!-- æ¬Šé™æç¤º -->
    <div id="permissionPrompt" style="display: none;">
        <div class="prompt-content">
            <h2 class="prompt-title">éœ€è¦æ”å½±æ©Ÿæ¬Šé™</h2>
            <p class="prompt-message">
                ç‚ºäº†é€²è¡Œæ‰‹å‹¢è¾¨è­˜ï¼Œéœ€è¦å­˜å–æ‚¨çš„æ”å½±æ©Ÿã€‚<br>
                è«‹å…è¨±æ”å½±æ©Ÿæ¬Šé™ä»¥é–‹å§‹éŠæˆ²ã€‚
            </p>
            <button class="prompt-btn" id="retryPermissionBtn">å…è¨±æ”å½±æ©Ÿå­˜å–</button>
        </div>
    </div>

    <!-- è¼‰å…¥å¤–éƒ¨è…³æœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script>
        // ==================== éŠæˆ²è®Šæ•¸ ====================
        let cameraStream = null;
        let hands = null;
        let gameActive = false;
        let gameStarted = false;
        let lastHandUpdate = 0;
        
        // è²“å’ªç‹€æ…‹
        let cat = {
            name: "æ©˜æ©˜",
            mood: "é–‹å¿ƒ",
            happiness: 80,
            energy: 60,
            hunger: 40,
            avatar: "ğŸ˜º"
        };
        
        // éŠæˆ²ç‹€æ…‹
        let gameStats = {
            playTime: 0,
            catchCount: 0,
            score: 0,
            combo: 0,
            maxCombo: 0
        };
        
        // æ‰‹å‹¢ç‹€æ…‹
        let handDetected = false;
        let handPosition = { x: 0, y: 0 };
        let currentGesture = null;
        let lastGestureTime = 0;
        
        // éŠæˆ²ç‰©ä»¶
        let catToy = {
            x: 0,
            y: 0,
            visible: false,
            speed: 5,
            size: 40
        };
        
        let catPosition = {
            x: 0,
            y: 0,
            speed: 2,
            size: 80
        };
        
        let snacks = [];
        let particles = [];
        
        // Canvas ç›¸é—œ
        let canvas, ctx;
        let animationFrameId = null;
        
        // DOMå…ƒç´ 
        const cameraFeed = document.getElementById('cameraFeed');
        const gameCanvas = document.getElementById('gameCanvas');
        const handStatusText = document.getElementById('handStatusText');
        const handPositionElement = document.getElementById('handPosition');
        const catAvatar = document.getElementById('catAvatar');
        const catName = document.getElementById('catName');
        const catMood = document.getElementById('catMood');
        const happinessValue = document.getElementById('happinessValue');
        const energyValue = document.getElementById('energyValue');
        const hungerValue = document.getElementById('hungerValue');
        const happinessBar = document.getElementById('happinessBar');
        const energyBar = document.getElementById('energyBar');
        const hungerBar = document.getElementById('hungerBar');
        const playTimeElement = document.getElementById('playTime');
        const catchCountElement = document.getElementById('catchCount');
        const scoreElement = document.getElementById('score');
        const comboElement = document.getElementById('combo');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const gameLog = document.getElementById('gameLog');
        const permissionPrompt = document.getElementById('permissionPrompt');
        const retryPermissionBtn = document.getElementById('retryPermissionBtn');
        const loadingScreen = document.getElementById('loadingScreen');
        
        // éŠæˆ²è¨­å®š
        const GAME_SETTINGS = {
            CAT_MOODS: {
                HAPPY: { emoji: "ğŸ˜º", text: "é–‹å¿ƒ", minHappiness: 70 },
                CONTENT: { emoji: "ğŸ˜¸", text: "æ»¿è¶³", minHappiness: 50 },
                BORED: { emoji: "ğŸ˜¾", text: "ç„¡èŠ", minHappiness: 30 },
                ANGRY: { emoji: "ğŸ˜¿", text: "ç”Ÿæ°£", minHappiness: 0 }
            },
            GESTURE_TYPES: {
                POINT_UP: "point_up",
                PINCH: "pinch",
                WAVE: "wave",
                FIST: "fist"
            },
            TOY_SPEED: 8,
            CAT_SPEED: 2,
            SNACK_COUNT: 5,
            PARTICLE_COUNT: 20
        };
        
        // ==================== åˆå§‹åŒ– ====================
        async function init() {
            try {
                // åˆå§‹åŒ– Canvas
                initCanvas();
                
                // åˆå§‹åŒ– MediaPipe Hands
                await initMediaPipe();
                
                // è¨­å®šäº‹ä»¶ç›£è½å™¨
                setupEventListeners();
                
                // åˆå§‹åŒ–éŠæˆ²ç‰©ä»¶
                initGameObjects();
                
                // é–‹å§‹éŠæˆ²å¾ªç’°
                gameLoop();
                
                // éš±è—è¼‰å…¥ç•«é¢
                setTimeout(() => {
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                    }, 500);
                }, 1000);
                
            } catch (error) {
                console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
                showPermissionPrompt();
            }
        }
        
        function initCanvas() {
            canvas = gameCanvas;
            ctx = canvas.getContext('2d');
            
            // è¨­å®š Canvas å¤§å°
            const container = document.querySelector('.camera-game-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            
            // è¦–çª—å¤§å°èª¿æ•´
            window.addEventListener('resize', () => {
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
            });
        }
        
        // ==================== MediaPipe Hands åˆå§‹åŒ– ====================
        async function initMediaPipe() {
            return new Promise((resolve, reject) => {
                hands = new Hands({
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                    }
                });
        
                hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
        
                hands.onResults(onHandResults);
        
                // è«‹æ±‚æ”å½±æ©Ÿæ¬Šé™
                requestCameraAccess().then(resolve).catch(reject);
            });
        }
        
        async function requestCameraAccess() {
            try {
                const constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                };
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // è¨­å®šå½±ç‰‡ä¸²æµ
                cameraFeed.srcObject = cameraStream;
                
                // å•Ÿå‹•ç›¸æ©Ÿ
                const camera = new Camera(cameraFeed, {
                    onFrame: async () => {
                        if (hands) {
                            await hands.send({ image: cameraFeed });
                        }
                    },
                    width: 640,
                    height: 480
                });
                
                camera.start();
                
            } catch (error) {
                console.error('æ”å½±æ©Ÿå­˜å–éŒ¯èª¤:', error);
                showPermissionPrompt();
                throw error;
            }
        }
        
        // ==================== æ‰‹å‹¢çµæœè™•ç† ====================
        function onHandResults(results) {
            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                handDetected = false;
                handStatusText.textContent = "ç­‰å¾…æ‰‹éƒ¨...";
                return;
            }
        
            const landmarks = results.multiHandLandmarks[0];
            handDetected = true;
            
            // è¨ˆç®—æ‰‹éƒ¨ä½ç½®ï¼ˆè½‰æ›ç‚ºç•«å¸ƒåº§æ¨™ï¼‰
            const indexFinger = landmarks[8]; // é£ŸæŒ‡å°–
            handPosition.x = indexFinger.x * canvas.width;
            handPosition.y = indexFinger.y * canvas.height;
            
            // æ›´æ–°é¡¯ç¤º
            handStatusText.textContent = "æ‰‹éƒ¨å·²åµæ¸¬";
            handPositionElement.textContent = `X: ${Math.round(handPosition.x)}, Y: ${Math.round(handPosition.y)}`;
            
            // è¾¨è­˜æ‰‹å‹¢
            const gesture = recognizeGesture(landmarks);
            
            if (gesture && gameActive) {
                handleGesture(gesture);
            }
            
            lastHandUpdate = Date.now();
        }
        
        // ==================== æ‰‹å‹¢è¾¨è­˜ ====================
        function recognizeGesture(landmarks) {
            const now = Date.now();
            if (now - lastGestureTime < 500) return null; // æ‰‹å‹¢å†·å»æ™‚é–“
            
            // æª¢æŸ¥é£ŸæŒ‡å‘ä¸Š
            if (isPointingUp(landmarks)) {
                lastGestureTime = now;
                return GAME_SETTINGS.GESTURE_TYPES.POINT_UP;
            }
            
            // æª¢æŸ¥æåˆæ‰‹å‹¢
            if (isPinching(landmarks)) {
                lastGestureTime = now;
                return GAME_SETTINGS.GESTURE_TYPES.PINCH;
            }
            
            // æª¢æŸ¥æ®æ‰‹
            if (isWaving(landmarks)) {
                lastGestureTime = now;
                return GAME_SETTINGS.GESTURE_TYPES.WAVE;
            }
            
            // æª¢æŸ¥æ¡æ‹³
            if (isFist(landmarks)) {
                lastGestureTime = now;
                return GAME_SETTINGS.GESTURE_TYPES.FIST;
            }
            
            return null;
        }
        
        function isPointingUp(landmarks) {
            const indexTip = landmarks[8];
            const indexBase = landmarks[5];
            const middleTip = landmarks[12];
            
            // é£ŸæŒ‡ä¼¸ç›´ä¸”æ¯”å…¶ä»–æ‰‹æŒ‡é«˜
            return indexTip.y < indexBase.y && 
                   indexTip.y < middleTip.y - 0.05;
        }
        
        function isPinching(landmarks) {
            const thumbTip = landmarks[4];
            const indexTip = landmarks[8];
            
            // è¨ˆç®—æ‹‡æŒ‡å’Œé£ŸæŒ‡è·é›¢
            const distance = Math.sqrt(
                Math.pow(thumbTip.x - indexTip.x, 2) +
                Math.pow(thumbTip.y - indexTip.y, 2)
            );
            
            return distance < 0.05; // æåˆé–¾å€¼
        }
        
        function isWaving(landmarks) {
            // ç°¡å–®çš„æ®æ‰‹æª¢æ¸¬ï¼šæ‰‹éƒ¨å¿«é€Ÿç§»å‹•
            // é€™è£¡ä½¿ç”¨ç°¡å–®çš„å¯¦ç¾ï¼Œå¯¦éš›æ‡‰è©²æª¢æ¸¬æ‰‹éƒ¨è»Œè·¡
            const fingersExtended = [8, 12, 16, 20].every(index => {
                const tip = landmarks[index];
                const base = landmarks[index - 3];
                return tip.y < base.y; // æŒ‡å°–åœ¨æŒ‡ç¯€ä¸Šæ–¹
            });
            
            return fingersExtended;
        }
        
        function isFist(landmarks) {
            const tips = [4, 8, 12, 16, 20];
            const bases = [2, 5, 9, 13, 17];
            
            // æª¢æŸ¥æ‰€æœ‰æŒ‡å°–æ˜¯å¦é è¿‘å°æ‡‰çš„æŒ‡ç¯€
            return tips.every((tipIndex, i) => {
                const tip = landmarks[tipIndex];
                const base = landmarks[bases[i]];
                const distance = Math.sqrt(
                    Math.pow(tip.x - base.x, 2) +
                    Math.pow(tip.y - base.y, 2)
                );
                return distance < 0.03; // æ‹³é ­é–¾å€¼
            });
        }
        
        // ==================== æ‰‹å‹¢è™•ç† ====================
        function handleGesture(gesture) {
            switch(gesture) {
                case GAME_SETTINGS.GESTURE_TYPES.POINT_UP:
                    spawnCatToy();
                    addLog("éŠæˆ²", "å¬å–šäº†é€—è²“æ£’ï¼");
                    break;
                    
                case GAME_SETTINGS.GESTURE_TYPES.PINCH:
                    if (catToy.visible) {
                        catchCatToy();
                    }
                    break;
                    
                case GAME_SETTINGS.GESTURE_TYPES.WAVE:
                    moveCatToy();
                    break;
                    
                case GAME_SETTINGS.GESTURE_TYPES.FIST:
                    spawnSnack();
                    break;
            }
        }
        
        // ==================== éŠæˆ²ç‰©ä»¶ç®¡ç† ====================
        function initGameObjects() {
            // åˆå§‹åŒ–è²“å’ªä½ç½®
            catPosition.x = canvas.width / 2;
            catPosition.y = canvas.height - 100;
            
            // åˆå§‹åŒ–é€—è²“æ£’
            catToy.x = canvas.width / 2;
            catToy.y = 100;
            
            // åˆå§‹åŒ–é›¶é£Ÿ
            snacks = [];
            for (let i = 0; i < GAME_SETTINGS.SNACK_COUNT; i++) {
                snacks.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height * 0.5,
                    size: 20,
                    active: false,
                    type: Math.floor(Math.random() * 3) // 0: é­š, 1: è‚‰, 2: é¤…ä¹¾
                });
            }
        }
        
        function spawnCatToy() {
            if (!catToy.visible) {
                catToy.visible = true;
                catToy.x = handPosition.x;
                catToy.y = handPosition.y;
                addLog("è²“å’ª", "çœ‹åˆ°é€—è²“æ£’äº†ï¼");
            }
        }
        
        function catchCatToy() {
            // è¨ˆç®—è²“å’ªå’Œé€—è²“æ£’çš„è·é›¢
            const distance = Math.sqrt(
                Math.pow(catPosition.x - catToy.x, 2) +
                Math.pow(catPosition.y - catToy.y, 2)
            );
            
            if (distance < catPosition.size + catToy.size) {
                // è²“å’ªæŠ“åˆ°é€—è²“æ£’
                gameStats.catchCount++;
                gameStats.combo++;
                gameStats.score += 10 * gameStats.combo;
                
                // è²“å’ªé–‹å¿ƒç¨‹åº¦å¢åŠ 
                cat.happiness = Math.min(100, cat.happiness + 5);
                
                // ç”¢ç”Ÿç²’å­æ•ˆæœ
                createParticles(catToy.x, catToy.y, 10);
                
                // éš±è—é€—è²“æ£’
                catToy.visible = false;
                
                // æ›´æ–°é¡¯ç¤º
                updateStats();
                updateCatStatus();
                
                addLog("è²“å’ª", `æŠ“åˆ°é€—è²“æ£’ï¼é€£çºŒæŠ“åˆ° ${gameStats.combo} æ¬¡`);
                
                // å¦‚æœé€£çºŒæŠ“åˆ°3æ¬¡ï¼Œçå‹µé¡å¤–åˆ†æ•¸
                if (gameStats.combo >= 3) {
                    gameStats.score += 50;
                    addLog("éŠæˆ²", `é€£çºŒæŠ“åˆ°çå‹µ +50åˆ†ï¼`);
                }
                
            } else {
                // æ²’æŠ“åˆ°ï¼Œé€£çºŒä¸­æ–·
                gameStats.combo = 0;
                addLog("è²“å’ª", "å·®ä¸€é»å°±æŠ“åˆ°äº†ï¼");
            }
        }
        
        function moveCatToy() {
            if (catToy.visible) {
                // è®“é€—è²“æ£’è·Ÿéš¨æ‰‹éƒ¨ç§»å‹•
                catToy.x += (handPosition.x - catToy.x) * 0.1;
                catToy.y += (handPosition.y - catToy.y) * 0.1;
                
                // è²“å’ªæœƒè¿½è¹¤é€—è²“æ£’
                const dx = catToy.x - catPosition.x;
                const dy = catToy.y - catPosition.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 50) {
                    catPosition.x += (dx / distance) * GAME_SETTINGS.CAT_SPEED;
                    catPosition.y += (dy / distance) * GAME_SETTINGS.CAT_SPEED;
                }
                
                // è²“å’ªæ´»åŠ›æ¸›å°‘
                cat.energy = Math.max(0, cat.energy - 0.1);
            }
        }
        
        function spawnSnack() {
            const snackTypes = ["ğŸŸ", "ğŸ–", "ğŸª"];
            const snackType = Math.floor(Math.random() * snackTypes.length);
            
            snacks.push({
                x: handPosition.x,
                y: handPosition.y,
                size: 20,
                active: true,
                type: snackType
            });
            
            addLog("è²“å’ª", `å‡ºç¾äº†${snackTypes[snackType]}é›¶é£Ÿï¼`);
        }
        
        function createParticles(x, y, count) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    size: Math.random() * 5 + 2,
                    speedX: (Math.random() - 0.5) * 10,
                    speedY: (Math.random() - 0.5) * 10,
                    life: 30,
                    color: i % 3 === 0 ? '#FF9A9E' : i % 3 === 1 ? '#FAD0C4' : '#FFD700'
                });
            }
        }
        
        // ==================== éŠæˆ²å¾ªç’° ====================
        function gameLoop() {
            if (gameActive) {
                updateGame();
                updateStats();
            }
            
            drawGame();
            animationFrameId = requestAnimationFrame(gameLoop);
        }
        
        function updateGame() {
            // æ›´æ–°éŠæˆ²æ™‚é–“
            gameStats.playTime += 0.016; // å¤§ç´„60fps
            
            // è‡ªå‹•æ¸›å°‘è²“å’ªç‹€æ…‹
            cat.happiness = Math.max(0, cat.happiness - 0.02);
            cat.energy = Math.max(0, cat.energy - 0.01);
            cat.hunger = Math.min(100, cat.hunger + 0.03);
            
            // æ›´æ–°è²“å’ªå¿ƒæƒ…
            updateCatMood();
            
            // æ›´æ–°ç²’å­
            updateParticles();
            
            // æ›´æ–°é›¶é£Ÿ
            updateSnacks();
            
            // æª¢æŸ¥è²“å’ªå’Œé›¶é£Ÿçš„äº’å‹•
            checkSnackCollision();
        }
        
        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.speedX;
                p.y += p.speedY;
                p.life--;
                
                if (p.life <= 0) {
                    particles.splice(i, 1);
                }
            }
        }
        
        function updateSnacks() {
            for (let i = snacks.length - 1; i >= 0; i--) {
                const snack = snacks[i];
                if (snack.active) {
                    // é›¶é£Ÿç·©æ…¢ä¸‹è½
                    snack.y += 1;
                    
                    // å¦‚æœæ‰å‡ºç•«é¢ï¼Œç§»é™¤
                    if (snack.y > canvas.height) {
                        snacks.splice(i, 1);
                    }
                }
            }
        }
        
        function checkSnackCollision() {
            for (let i = snacks.length - 1; i >= 0; i--) {
                const snack = snacks[i];
                if (!snack.active) continue;
                
                const distance = Math.sqrt(
                    Math.pow(catPosition.x - snack.x, 2) +
                    Math.pow(catPosition.y - snack.y, 2)
                );
                
                if (distance < catPosition.size + snack.size) {
                    // è²“å’ªåƒåˆ°é›¶é£Ÿ
                    cat.hunger = Math.max(0, cat.hunger - 20);
                    cat.happiness = Math.min(100, cat.happiness + 10);
                    gameStats.score += 20;
                    
                    // ç”¢ç”Ÿç²’å­æ•ˆæœ
                    createParticles(snack.x, snack.y, 15);
                    
                    // ç§»é™¤é›¶é£Ÿ
                    snacks.splice(i, 1);
                    
                    addLog("è²“å’ª", "åƒåˆ°äº†ç¾å‘³çš„é›¶é£Ÿï¼");
                    updateCatStatus();
                }
            }
        }
        
        // ==================== ç¹ªè£½éŠæˆ² ====================
        function drawGame() {
            // æ¸…é™¤ç•«å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç¹ªè£½èƒŒæ™¯è£é£¾
            drawBackground();
            
            // ç¹ªè£½é›¶é£Ÿ
            drawSnacks();
            
            // ç¹ªè£½è²“å’ª
            drawCat();
            
            // ç¹ªè£½é€—è²“æ£’
            if (catToy.visible) {
                drawCatToy();
            }
            
            // ç¹ªè£½ç²’å­
            drawParticles();
            
            // ç¹ªè£½æ‰‹éƒ¨ä½ç½®æŒ‡ç¤º
            if (handDetected) {
                drawHandIndicator();
            }
        }
        
        function drawBackground() {
            // ç¹ªè£½æ¼¸å±¤èƒŒæ™¯
            const gradient = ctx.createRadialGradient(
                canvas.width / 2, canvas.height / 2, 0,
                canvas.width / 2, canvas.height / 2, Math.max(canvas.width, canvas.height) / 2
            );
            gradient.addColorStop(0, 'rgba(255, 154, 158, 0.1)');
            gradient.addColorStop(0.5, 'rgba(250, 208, 196, 0.05)');
            gradient.addColorStop(1, 'rgba(26, 26, 46, 0)');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç¹ªè£½åœ°æ¿
            ctx.fillStyle = 'rgba(139, 69, 19, 0.3)';
            ctx.fillRect(0, canvas.height - 50, canvas.width, 50);
        }
        
        function drawCat() {
            // ç¹ªè£½è²“å’ªèº«é«”
            ctx.save();
            ctx.translate(catPosition.x, catPosition.y);
            
            // ç¹ªè£½è²“å’ªè¡¨æƒ…
            ctx.font = `${catPosition.size}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#FFFFFF';
            ctx.fillText(cat.avatar, 0, 0);
            
            // ç¹ªè£½è²“å’ªåå­—
            ctx.font = '16px Arial';
            ctx.fillStyle = '#FFD700';
            ctx.fillText(cat.name, 0, -catPosition.size - 20);
            
            ctx.restore();
            
            // ç¹ªè£½è²“å’ªå½±å­
            ctx.beginPath();
            ctx.ellipse(catPosition.x, catPosition.y + catPosition.size / 2, 
                       catPosition.size / 2, catPosition.size / 8, 0, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.fill();
        }
        
        function drawCatToy() {
            // ç¹ªè£½é€—è²“æ£’æ£’å­
            ctx.beginPath();
            ctx.moveTo(catToy.x, catToy.y);
            ctx.lineTo(catToy.x, catToy.y - 100);
            ctx.strokeStyle = '#8B4513';
            ctx.lineWidth = 5;
            ctx.stroke();
            
            // ç¹ªè£½é€—è²“æ£’é ‚éƒ¨
            ctx.beginPath();
            ctx.arc(catToy.x, catToy.y - 100, 20, 0, Math.PI * 2);
            ctx.fillStyle = '#FF9A9E';
            ctx.fill();
            ctx.strokeStyle = '#FF6B6B';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // ç¹ªè£½ç¾½æ¯›
            for (let i = 0; i < 3; i++) {
                const angle = (i * 120) * Math.PI / 180;
                ctx.beginPath();
                ctx.moveTo(catToy.x, catToy.y - 100);
                ctx.lineTo(
                    catToy.x + Math.cos(angle) * 30,
                    catToy.y - 100 + Math.sin(angle) * 30
                );
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }
        
        function drawSnacks() {
            const snackEmojis = ["ğŸŸ", "ğŸ–", "ğŸª"];
            
            snacks.forEach(snack => {
                if (!snack.active) return;
                
                ctx.save();
                ctx.translate(snack.x, snack.y);
                
                // ç¹ªè£½é›¶é£Ÿé™°å½±
                ctx.font = `${snack.size}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.fillText(snackEmojis[snack.type], 2, 2);
                
                // ç¹ªè£½é›¶é£Ÿ
                ctx.fillStyle = '#FFFFFF';
                ctx.fillText(snackEmojis[snack.type], 0, 0);
                
                ctx.restore();
            });
        }
        
        function drawParticles() {
            particles.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.life / 30;
                ctx.fill();
                ctx.globalAlpha = 1;
            });
        }
        
        function drawHandIndicator() {
            // ç¹ªè£½æ‰‹éƒ¨ä½ç½®åœ“åœˆ
            ctx.beginPath();
            ctx.arc(handPosition.x, handPosition.y, 20, 0, Math.PI * 2);
            ctx.strokeStyle = '#FF9A9E';
            ctx.lineWidth = 3;
            ctx.setLineDash([5, 5]);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // ç¹ªè£½æ‰‹éƒ¨ä½ç½®é»
            ctx.beginPath();
            ctx.arc(handPosition.x, handPosition.y, 5, 0, Math.PI * 2);
            ctx.fillStyle = '#FF9A9E';
            ctx.fill();
        }
        
        // ==================== éŠæˆ²æ§åˆ¶ ====================
        function startGame() {
            if (gameActive) return;
            
            gameActive = true;
            gameStarted = true;
            startBtn.disabled = true;
            startBtn.textContent = "éŠæˆ²é€²è¡Œä¸­";
            
            // é‡ç½®éŠæˆ²çµ±è¨ˆ
            gameStats = {
                playTime: 0,
                catchCount: 0,
                score: 0,
                combo: 0,
                maxCombo: 0
            };
            
            // é‡ç½®è²“å’ªç‹€æ…‹
            cat = {
                name: "æ©˜æ©˜",
                mood: "é–‹å¿ƒ",
                happiness: 80,
                energy: 60,
                hunger: 40,
                avatar: "ğŸ˜º"
            };
            
            // åˆå§‹åŒ–éŠæˆ²ç‰©ä»¶
            initGameObjects();
            
            // æ›´æ–°é¡¯ç¤º
            updateCatStatus();
            updateStats();
            
            addLog("ç³»çµ±", "éŠæˆ²é–‹å§‹ï¼ç”¨æ‰‹å‹¢èˆ‡è²“å’ªäº’å‹•å§ï¼");
        }
        
        function resetGame() {
            if (gameActive && !confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹éŠæˆ²å—ï¼Ÿ')) {
                return;
            }
            
            gameActive = false;
            gameStarted = false;
            startBtn.disabled = false;
            startBtn.textContent = "ğŸ® é–‹å§‹éŠæˆ²";
            
            // é‡ç½®éŠæˆ²çµ±è¨ˆ
            gameStats = {
                playTime: 0,
                catchCount: 0,
                score: 0,
                combo: 0,
                maxCombo: 0
            };
            
            // é‡ç½®è²“å’ªç‹€æ…‹
            cat = {
                name: "æ©˜æ©˜",
                mood: "é–‹å¿ƒ",
                happiness: 80,
                energy: 60,
                hunger: 40,
                avatar: "ğŸ˜º"
            };
            
            // åˆå§‹åŒ–éŠæˆ²ç‰©ä»¶
            initGameObjects();
            
            // æ›´æ–°é¡¯ç¤º
            updateCatStatus();
            updateStats();
            
            addLog("ç³»çµ±", "éŠæˆ²å·²é‡ç½®");
        }
        
        // ==================== æ›´æ–°é¡¯ç¤º ====================
        function updateCatStatus() {
            catAvatar.textContent = cat.avatar;
            catName.textContent = cat.name;
            catMood.textContent = `å¿ƒæƒ…ï¼š${cat.mood}`;
            
            happinessValue.textContent = `${Math.round(cat.happiness)}%`;
            energyValue.textContent = `${Math.round(cat.energy)}%`;
            hungerValue.textContent = `${Math.round(cat.hunger)}%`;
            
            happinessBar.style.width = `${cat.happiness}%`;
            energyBar.style.width = `${cat.energy}%`;
            hungerBar.style.width = `${cat.hunger}%`;
        }
        
        function updateCatMood() {
            if (cat.happiness >= 70) {
                cat.mood = "é–‹å¿ƒ";
                cat.avatar = "ğŸ˜º";
            } else if (cat.happiness >= 50) {
                cat.mood = "æ»¿è¶³";
                cat.avatar = "ğŸ˜¸";
            } else if (cat.happiness >= 30) {
                cat.mood = "ç„¡èŠ";
                cat.avatar = "ğŸ˜¾";
            } else {
                cat.mood = "ç”Ÿæ°£";
                cat.avatar = "ğŸ˜¿";
            }
            
            updateCatStatus();
        }
        
        function updateStats() {
            playTimeElement.textContent = Math.round(gameStats.playTime);
            catchCountElement.textContent = gameStats.catchCount;
            scoreElement.textContent = gameStats.score;
            comboElement.textContent = gameStats.combo;
            
            // æ›´æ–°æœ€å¤§é€£çºŒæŠ“åˆ°
            if (gameStats.combo > gameStats.maxCombo) {
                gameStats.maxCombo = gameStats.combo;
            }
        }
        
        function addLog(sender, message) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-TW', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-time">[${timeString}]</span> [${sender}] ${message}`;
            
            gameLog.appendChild(logEntry);
            gameLog.scrollTop = gameLog.scrollHeight;
            
            // é™åˆ¶æ—¥èªŒæ•¸é‡
            if (gameLog.children.length > 10) {
                gameLog.removeChild(gameLog.firstChild);
            }
        }
        
        // ==================== äº‹ä»¶ç›£è½å™¨ ====================
        function setupEventListeners() {
            startBtn.addEventListener('click', startGame);
            resetBtn.addEventListener('click', resetGame);
            retryPermissionBtn.addEventListener('click', retryCameraAccess);
            
            // è¦–çª—å¤§å°èª¿æ•´
            window.addEventListener('resize', () => {
                const container = document.querySelector('.camera-game-container');
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
            });
        }
        
        function showPermissionPrompt() {
            permissionPrompt.style.display = 'flex';
            loadingScreen.style.display = 'none';
        }
        
        async function retryCameraAccess() {
            permissionPrompt.style.display = 'none';
            
            try {
                await requestCameraAccess();
            } catch (error) {
                showPermissionPrompt();
            }
        }
        
        // ==================== å•Ÿå‹•éŠæˆ² ====================
        // ç­‰å¾…é é¢è¼‰å…¥å®Œæˆ
        window.addEventListener('load', init);
        
        // è™•ç†é é¢å¸è¼‰
        window.addEventListener('beforeunload', () => {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
        });
    </script>
</body>
</html>