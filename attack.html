<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>é«”æ„Ÿæ”»æ“Šï¼šæ•¸å­¸è€å¸«ï¼</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: 'Arial', sans-serif; }
        #ui { position: absolute; top: 10px; left: 10px; color: yellow; z-index: 10; text-shadow: 2px 2px #000; }
        canvas { position: absolute; top: 0; left: 0; }
        /* éš±è—åŸå§‹é¡é ­ç•«é¢ï¼Œæˆ‘å€‘æŠŠå®ƒç•«åœ¨ Canvas ä¸Š */
        #video { display: none; }
        .loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 24px; }
    </style>
</head>
<body>

<div id="ui">
    <h2>ğŸ‘‹ æ‰‹å‹¢é«”æ„Ÿç‰ˆï¼šæ“Šé€€å¯¦ç¿’è€å¸«</h2>
    <p>åˆ†æ•¸: <span id="score">0</span> | æ™‚é–“: <span id="timer">30</span>s</p>
    <p style="color: #00ff00;">æç¤ºï¼šç§»å‹•é£ŸæŒ‡å°–ç«¯å³å¯æ”»æ“Šï¼</p>
</div>
<div id="loading" class="loading">æ¨¡å‹è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™ä¸¦é–‹å•Ÿé¡é ­...</div>

<video id="video"></video>
<canvas id="gameCanvas"></canvas>

<script>
const videoElement = document.getElementById('video');
const canvasElement = document.getElementById('gameCanvas');
const canvasCtx = canvasElement.getContext('2d');
const scoreEl = document.getElementById('score');
const timerEl = document.getElementById('timer');
const loadingEl = document.getElementById('loading');

canvasElement.width = window.innerWidth;
canvasElement.height = window.innerHeight;

let score = 0;
let timeLeft = 30;
let gameActive = true;
const formulas = ['f(x)', 'âˆ«', 'dx', 'lim', 'Î£', 'âˆšx'];

// è€å¸«ç‰©ä»¶
const teacher = { x: 200, y: 200, dx: 4, dy: 4, size: 100, emoji: 'ğŸ‘¨â€ğŸ«' };

// æ‰‹éƒ¨åµæ¸¬é‚è¼¯
function onResults(results) {
    loadingEl.style.display = 'none';
    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    
    // é¡åƒç¿»è½‰ä¸¦ç•«å‡ºèƒŒæ™¯é¡é ­å½±åƒ
    canvasCtx.translate(canvasElement.width, 0);
    canvasCtx.scale(-1, 1);
    canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
    
    // éŠæˆ²é‚è¼¯
    if (gameActive) {
        updateTeacher();
        drawTeacher();

        if (results.multiHandLandmarks) {
            for (const landmarks of results.multiHandLandmarks) {
                // å–å¾—é£ŸæŒ‡å°–ç«¯ (é» 8)
                const indexTip = landmarks[8];
                const x = (1 - indexTip.x) * canvasElement.width; // å› ç‚ºé¡åƒæ‰€ä»¥ 1-x
                const y = indexTip.y * canvasElement.height;

                // ç•«å‡ºæº–æ˜Ÿ
                drawCrosshair(x, y);
                
                // ç¢°æ’åµæ¸¬
                checkHit(x, y);
            }
        }
    }
    canvasCtx.restore();
}

function updateTeacher() {
    teacher.x += teacher.dx;
    teacher.y += teacher.dy;
    if (teacher.x > canvasElement.width - 100 || teacher.x < 0) teacher.dx *= -1;
    if (teacher.y > canvasElement.height - 100 || teacher.y < 0) teacher.dy *= -1;
}

function drawTeacher() {
    canvasCtx.font = '100px Arial';
    // é€™è£¡è¦è™•ç†é¡åƒå¾Œçš„æ–‡å­—ç¿»è½‰å•é¡Œ
    canvasCtx.save();
    canvasCtx.translate(teacher.x + 50, teacher.y + 50);
    canvasCtx.scale(-1, 1);
    canvasCtx.fillText(teacher.emoji, -50, 40);
    canvasCtx.restore();
}

function drawCrosshair(x, y) {
    canvasCtx.fillStyle = '#ff3e3e';
    canvasCtx.font = '30px Arial';
    canvasCtx.fillText(formulas[Math.floor(Date.now()/500) % formulas.length], x - 20, y);
    
    canvasCtx.strokeStyle = 'lime';
    canvasCtx.beginPath();
    canvasCtx.arc(x, y, 15, 0, Math.PI * 2);
    canvasCtx.stroke();
}

function checkHit(x, y) {
    const dist = Math.hypot(x - (teacher.x + 50), y - (teacher.y + 50));
    if (dist < 60) {
        score++;
        scoreEl.innerText = score;
        // è¢«æ‰“åˆ°é–ƒçˆä¸€ä¸‹
        teacher.x = Math.random() * (canvasElement.width - 100);
        teacher.y = Math.random() * (canvasElement.height - 100);
    }
}

// åˆå§‹åŒ– MediaPipe
const hands = new Hands({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});
hands.setOptions({
    maxNumHands: 1,
    modelComplexity: 1,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
});
hands.onResults(onResults);

const camera = new Camera(videoElement, {
    onFrame: async () => {
        await hands.send({image: videoElement});
    },
    width: 1280,
    height: 720
});
camera.start();

// è¨ˆæ™‚å™¨
const timerInterval = setInterval(() => {
    if (timeLeft > 0) {
        timeLeft--;
        timerEl.innerText = timeLeft;
    } else {
        gameActive = false;
        alert("æ™‚é–“åˆ°ï¼ä½ æˆåŠŸé˜»æ­¢äº†å¯¦ç¿’è€å¸«çš„å‡ºé¡Œï¼ç¸½åˆ†ï¼š" + score);
        clearInterval(timerInterval);
    }
}, 1000);
</script>
</body>
</html>