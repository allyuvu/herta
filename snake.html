<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»‘è‰²è²ªåƒè›‡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #111;
            color: #eee;
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
            max-width: 600px;
        }
        
        h1 {
            color: #ff4444;
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }
        
        .subtitle {
            color: #aaa;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        
        .game-container {
            position: relative;
            width: 100%;
            max-width: 600px;
        }
        
        #gameCanvas {
            background-color: #000;
            border: 2px solid #333;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.2);
            display: block;
            margin: 0 auto;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 600px;
            margin-top: 15px;
            padding: 10px 0;
            border-top: 1px solid #333;
            border-bottom: 1px solid #333;
        }
        
        .score-container, .high-score-container {
            text-align: center;
            font-size: 1.3rem;
        }
        
        .score-value, .high-score-value {
            color: #4CAF50;
            font-weight: bold;
            font-size: 1.8rem;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            width: 100%;
            max-width: 600px;
        }
        
        button {
            background-color: #333;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1.1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 140px;
        }
        
        button:hover {
            background-color: #444;
            transform: translateY(-2px);
        }
        
        #startBtn {
            background-color: #4CAF50;
        }
        
        #startBtn:hover {
            background-color: #45a049;
        }
        
        #restartBtn {
            background-color: #ff4444;
        }
        
#restartBtn:hover {
            background-color: #ff3333;
        }
        
        .audio-control {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #333;
            border: 2px solid #555;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .audio-control:hover {
            background-color: #444;
            transform: scale(1.1);
        }
        
        .audio-control.muted {
            background-color: #ff4444;
            border-color: #ff6666;
        }
        
        .audio-control .speaker-icon {
            width: 24px;
            height: 24px;
            fill: white;
        }
        
        .audio-control .speaker-muted {
            display: none;
        }
        
        .audio-control.muted .speaker-normal {
            display: none;
        }
        
        .audio-control.muted .speaker-muted {
            display: block;
        }
        
        /* æ§åˆ¶æç¤ºè¦†å±¤ */
        .controls-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            border-radius: 8px;
        }
        
        .controls-overlay.show {
            display: flex;
        }
        
        .controls-content {
            text-align: center;
            max-width: 80%;
        }
        
        .controls-content h3 {
            color: #ff4444;
            font-size: 2rem;
            margin-bottom: 20px;
        }
        
        .control-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
        
        .control-key {
            background: #333;
            padding: 5px 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 1.1rem;
            color: #4CAF50;
            border: 1px solid #555;
            min-width: 80px;
            text-align: center;
        }
        
        .control-desc {
            margin-left: 20px;
            color: #ccc;
            font-size: 1rem;
        }
        
        .close-controls {
            background: #ff4444;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1rem;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }
        
        .close-controls:hover {
            background: #ff3333;
            transform: translateY(-2px);
        }
        
        /* éµç›¤å¿«æ·éµæç¤º */
        .keyboard-hint {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .keyboard-hint.show {
            opacity: 1;
        }
        
        /* æˆå°±ç³»çµ±æ¨£å¼ */
        .achievement-popup {
            position: fixed;
            top: 80px;
            right: -400px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.95), rgba(255, 140, 0, 0.95));
            color: #333;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 2000;
            transition: right 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 350px;
            backdrop-filter: blur(10px);
        }
        
        .achievement-popup.show {
            right: 20px;
        }
        
        .achievement-icon {
            font-size: 2.5rem;
            animation: bounce 0.6s ease infinite alternate;
        }
        
        .achievement-content h4 {
            margin: 0 0 5px 0;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .achievement-content p {
            margin: 0;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-5px); }
        }
        
        /* æˆå°±é¢æ¿ */
        .achievements-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            z-index: 3000;
            transition: right 0.3s ease;
            overflow-y: auto;
            padding: 20px;
        }
        
        .achievements-panel.show {
            right: 0;
        }
        
        .achievements-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #333;
        }
        
        .achievements-header h3 {
            color: #ff4444;
            font-size: 1.5rem;
            margin: 0;
        }
        
        .close-achievements {
            background: #333;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .close-achievements:hover {
            background: #555;
        }
        
        .achievement-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
        }
        
        .achievement-item.unlocked {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .achievement-item.locked {
            opacity: 0.5;
        }
        
        .achievement-item-icon {
            font-size: 2rem;
            min-width: 50px;
            text-align: center;
        }
        
        .achievement-item-info h4 {
            margin: 0 0 5px 0;
            color: white;
            font-size: 1.1rem;
        }
        
        .achievement-item-info p {
            margin: 0;
            color: #aaa;
            font-size: 0.9rem;
        }
        
        .achievement-progress {
            margin-top: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 6px;
            overflow: hidden;
        }
        
        .achievement-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
        }
        
        /* æˆå°±æŒ‰éˆ• */
        .achievements-btn {
            position: fixed;
            top: 140px;
            right: 20px;
            background: rgba(255, 215, 0, 0.9);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 1000;
            font-size: 1.5rem;
        }
        
        .achievements-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.3);
        }
        
        .achievements-btn.has-new {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }
        
        .instructions {
            background-color: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            margin-top: 25px;
            width: 100%;
            max-width: 600px;
            border-left: 4px solid #ff4444;
        }
        
        .instructions h3 {
            color: #ff4444;
            margin-bottom: 10px;
            font-size: 1.4rem;
        }
        
        .instructions p {
            margin-bottom: 8px;
            line-height: 1.5;
            color: #ccc;
        }
        
        .instructions ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .instructions li {
            margin-bottom: 8px;
            line-height: 1.5;
            color: #ccc;
        }
        
        .mobile-controls {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 10px;
            margin-top: 25px;
            width: 100%;
            max-width: 300px;
        }
        
        .mobile-btn {
            background-color: #333;
            color: white;
            border: none;
            padding: 20px;
            font-size: 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mobile-btn.up {
            grid-column: 2;
            grid-row: 1;
        }
        
        .mobile-btn.down {
            grid-column: 2;
            grid-row: 2;
        }
        
        .mobile-btn.left {
            grid-column: 1;
            grid-row: 2;
        }
        
        .mobile-btn.right {
            grid-column: 3;
            grid-row: 2;
        }
        
        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            z-index: 10;
        }
        
        .game-over h2 {
            color: #ff4444;
            font-size: 3rem;
            margin-bottom: 20px;
        }
        
        .game-over p {
            font-size: 1.5rem;
            margin-bottom: 30px;
        }
        
/* ç§»åŠ¨ç«¯æ§åˆ¶æŒ‰é’®æ ·å¼ */
        .mobile-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(3, 60px);
            gap: 10px;
            z-index: 100;
        }
        
        .mobile-btn {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .mobile-btn:active {
            background: rgba(255, 68, 68, 0.8);
            border-color: #ff4444;
            transform: scale(0.95);
        }
        
        .mobile-btn.up { grid-column: 2; grid-row: 1; }
        .mobile-btn.left { grid-column: 1; grid-row: 2; }
        .mobile-btn.right { grid-column: 3; grid-row: 2; }
        .mobile-btn.down { grid-column: 2; grid-row: 3; }
        
        /* ç§»åŠ¨ç«¯æ‰‹åŠ¿æ”¯æŒ */
        .gesture-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            z-index: 50;
            touch-action: none;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 2.2rem;
                margin-bottom: 8px;
            }
            
            .subtitle {
                font-size: 1rem;
                margin-bottom: 15px;
            }
            
            .game-container {
                max-width: 100%;
                margin-bottom: 15px;
            }
            
            #gameCanvas {
                width: 100%;
                max-width: 500px;
                height: auto;
                border-width: 1px;
            }
            
            .game-info {
                font-size: 1.1rem;
                padding: 8px 0;
            }
            
            .score-value, .high-score-value {
                font-size: 1.5rem;
            }
            
            .controls {
                gap: 10px;
                margin-top: 15px;
            }
            
            button {
                padding: 10px 20px;
                font-size: 1rem;
                min-width: 120px;
            }
            
            .mobile-controls {
                display: grid;
            }
            
            .audio-control {
                width: 45px;
                height: 45px;
                top: 15px;
                right: 15px;
            }
            
            .achievements-btn {
                width: 45px;
                height: 45px;
                top: 70px;
                right: 15px;
                font-size: 1.3rem;
            }
            
            .keyboard-hint {
                display: none; /* ç§»åŠ¨ç«¯éšè—é”®ç›˜æç¤º */
            }
            
            .controls-overlay {
                padding: 20px;
            }
            
            .controls-overlay h3 {
                font-size: 1.5rem;
            }
            
            .control-item {
                margin: 10px 0;
                padding: 8px;
            }
            
            .control-key {
                font-size: 0.9rem;
                min-width: 60px;
            }
            
            .control-desc {
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.8rem;
            }
            
            .subtitle {
                font-size: 0.9rem;
            }
            
            .controls {
                flex-direction: row;
                justify-content: space-between;
                flex-wrap: nowrap;
                gap: 8px;
            }
            
            button {
                padding: 8px 15px;
                font-size: 0.9rem;
                min-width: 100px;
                flex: 1;
            }
            
            .mobile-controls {
                bottom: 10px;
                gap: 8px;
            }
            
            .mobile-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .game-container {
                margin-bottom: 120px; /* ä¸ºæ§åˆ¶æŒ‰é’®ç•™å‡ºç©ºé—´ */
            }
            
            .gesture-area {
                height: 150px;
            }
        }
        
        @media (max-width: 320px) {
            h1 {
                font-size: 1.5rem;
            }
            
            .mobile-btn {
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }
            
            .controls {
                flex-direction: column;
                gap: 8px;
            }
            
            button {
                width: 100%;
                min-width: auto;
            }
        }
        
        /* é˜²æ­¢ç¼©æ”¾ */
        input, textarea, select {
            font-size: 16px;
        }
        
        /* ä¼˜åŒ–è§¦æ‘¸ä½“éªŒ */
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        input, textarea {
            -webkit-user-select: auto;
            user-select: auto;
        }
        
        /* è§†å£ä¼˜åŒ– */
        @viewport {
            width: device-width;
            zoom: 1.0;
        }
    </style>
</head>
<body>
    <!-- éµç›¤å¿«æ·éµæç¤ºï¼ˆæ¡Œé¢ç«¯ï¼‰ -->
    <div class="keyboard-hint" id="keyboardHint">æŒ‰ H æŸ¥çœ‹æ§åˆ¶è¯´æ˜</div>
    
    <!-- ç§»åŠ¨ç«¯æç¤º -->
    <div class="mobile-hint" id="mobileHint" style="display: none; position: fixed; bottom: 220px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; z-index: 100;">æ»‘åŠ¨æ§åˆ¶æ–¹å‘</div>
    
    <!-- æˆå°±æŒ‰éˆ• -->
    <div class="achievements-btn" id="achievementsBtn" title="æŸ¥çœ‹æˆå°± (A)">ğŸ†</div>
    
    <!-- æˆå°±é¢æ¿ -->
    <div class="achievements-panel" id="achievementsPanel">
        <div class="achievements-header">
            <h3>ğŸ† æˆå°±ç³»ç»Ÿ</h3>
            <button class="close-achievements" id="closeAchievements">å…³é—­</button>
        </div>
        <div id="achievementsList"></div>
    </div>
    
    <!-- æˆå°±å¼¹çª— -->
    <div class="achievement-popup" id="achievementPopup">
        <div class="achievement-icon">ğŸ†</div>
        <div class="achievement-content">
            <h4 id="achievementTitle">æˆå°±è§£é”ï¼</h4>
            <p id="achievementDesc">æè¿°</p>
        </div>
    </div>
    
    <!-- éŸ³æ•ˆæ§åˆ¶æŒ‰éˆ• -->
    <div class="audio-control" id="audioControl" title="åˆ‡æ¢éŸ³æ•ˆ (M)">
        <svg class="speaker-icon speaker-normal" viewBox="0 0 24 24">
            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
        </svg>
        <svg class="speaker-icon speaker-muted" viewBox="0 0 24 24">
            <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
        </svg>
    </div>
    
    <header>
        <h1>é»‘è‰²è´ªåƒè›‡</h1>
        <p class="subtitle">åƒåˆ°çº¢è‰²è‹¹æœä¼šå˜é•¿ï¼Œé¿å¼€å¢™å£å’Œè‡ªå·±ï¼</p>
    </header>
    
<div class="game-container">
        <canvas id="gameCanvas" width="600" height="400"></canvas>
        
        <div class="controls-overlay" id="controlsOverlay">
            <div class="controls-content">
                <h3>ğŸ® æ§åˆ¶è¯´æ˜</h3>
                <div class="control-item">
                    <span class="control-key">â†‘ â†“ â† â†’</span>
                    <span class="control-desc">æ§åˆ¶è›‡çš„ç§»åŠ¨æ–¹å‘</span>
                </div>
                <div class="control-item">
                    <span class="control-key">SPACE</span>
                    <span class="control-desc">æš‚åœ/ç»§ç»­æ¸¸æˆ</span>
                </div>
                <div class="control-item">
                    <span class="control-key">R</span>
                    <span class="control-desc">é‡æ–°å¼€å§‹æ¸¸æˆ</span>
                </div>
                <div class="control-item">
                    <span class="control-key">H</span>
                    <span class="control-desc">æ˜¾ç¤º/éšè—æ§åˆ¶è¯´æ˜</span>
                </div>
                <div class="control-item">
                    <span class="control-key">M</span>
                    <span class="control-desc">é™éŸ³/å¼€å¯éŸ³æ•ˆ</span>
                </div>
                <button class="close-controls" id="closeControls">å¼€å§‹æ¸¸æˆ</button>
            </div>
        </div>
        
        <div class="game-over" id="gameOverScreen">
            <h2>æ¸¸æˆç»“æŸï¼</h2>
            <p>ä½ çš„åˆ†æ•°: <span id="finalScore">0</span></p>
            <button id="restartBtn2">é‡æ–°å¼€å§‹</button>
        </div>
    </div>
    
    <div class="game-info">
        <div class="score-container">
            <div>åˆ†æ•°</div>
            <div class="score-value" id="score">0</div>
        </div>
        <div class="high-score-container">
            <div>æœ€é«˜åˆ†</div>
            <div class="high-score-value" id="highScore">0</div>
        </div>
    </div>
    
    <div class="controls">
        <button id="startBtn">å¼€å§‹æ¸¸æˆ</button>
        <button id="pauseBtn">æš‚åœæ¸¸æˆ</button>
        <button id="restartBtn">é‡æ–°å¼€å§‹</button>
    </div>
    
    <!-- ç§»åŠ¨ç«¯æ‰‹åŠ¿åŒºåŸŸ -->
    <div class="gesture-area" id="gestureArea"></div>
    
    <div class="mobile-controls">
        <button class="mobile-btn up" id="upBtn">â†‘</button>
        <button class="mobile-btn down" id="downBtn">â†“</button>
        <button class="mobile-btn left" id="leftBtn">â†</button>
        <button class="mobile-btn right" id="rightBtn">â†’</button>
    </div>
    
    <div class="instructions">
        <h3>æ¸¸æˆè¯´æ˜</h3>
        <p>ä½¿ç”¨é”®ç›˜æ–¹å‘é”®æˆ–å±å¹•ä¸Šçš„æŒ‰é’®æ§åˆ¶è›‡çš„ç§»åŠ¨æ–¹å‘ã€‚</p>
        <ul>
            <li>ç›®æ ‡æ˜¯åƒåˆ°çº¢è‰²è‹¹æœï¼Œæ¯åƒä¸€ä¸ªè‹¹æœå¾—10åˆ†ï¼Œè›‡èº«ä¼šå˜é•¿</li>
            <li>é¿å…æ’åˆ°å¢™å£æˆ–è‡ªå·±çš„èº«ä½“</li>
            <li>è›‡ç§»åŠ¨å¾—è¶Šå¿«ï¼Œéš¾åº¦è¶Šé«˜</li>
            <li>æ¸¸æˆæ²¡æœ‰æ—¶é—´é™åˆ¶ï¼Œå°½å¯èƒ½è·å¾—é«˜åˆ†ï¼</li>
        </ul>
    </div>

    <script>
        // éŸ³æ•ˆç®¡ç†å™¨
        class AudioManager {
            constructor() {
                this.audioContext = null;
                this.sounds = {};
                this.volume = 0.3;
                this.enabled = true;
                this.init();
            }
            
            init() {
                try {
                    window.AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.audioContext = new AudioContext();
                    this.generateSounds();
                } catch (e) {
                    console.log('Web Audio API not supported');
                    this.enabled = false;
                }
            }
            
            generateSounds() {
                // ç”Ÿæˆåƒé£Ÿç‰©éŸ³æ•ˆï¼ˆä¸Šå‡éŸ³èª¿ï¼‰
                this.sounds.eat = () => {
                    if (!this.enabled) return;
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(400, this.audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(800, this.audioContext.currentTime + 0.1);
                    
                    gainNode.gain.setValueAtTime(this.volume, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.1);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + 0.1);
                };
                
                // ç”ŸæˆéŠæˆ²çµæŸéŸ³æ•ˆï¼ˆä¸‹é™éŸ³èª¿ï¼‰
                this.sounds.gameOver = () => {
                    if (!this.enabled) return;
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(300, this.audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(100, this.audioContext.currentTime + 0.5);
                    
                    gainNode.gain.setValueAtTime(this.volume, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + 0.5);
                };
                
                // ç”Ÿæˆç§»å‹•éŸ³æ•ˆï¼ˆè¼•å¾®é»æ“Šè²ï¼‰
                this.sounds.move = () => {
                    if (!this.enabled) return;
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(150, this.audioContext.currentTime);
                    
                    gainNode.gain.setValueAtTime(this.volume * 0.1, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.02);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + 0.02);
                };
                
                // ç”ŸæˆæŒ‰éˆ•éŸ³æ•ˆ
                this.sounds.button = () => {
                    if (!this.enabled) return;
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(600, this.audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(400, this.audioContext.currentTime + 0.05);
                    
                    gainNode.gain.setValueAtTime(this.volume * 0.2, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.05);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + 0.05);
                };
                
                // ç”Ÿæˆæš«åœéŸ³æ•ˆ
                this.sounds.pause = () => {
                    if (!this.enabled) return;
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(200, this.audioContext.currentTime);
                    
                    gainNode.gain.setValueAtTime(this.volume * 0.3, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.2);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + 0.2);
                };
                
                // ç”Ÿæˆæˆå°±è§£é–éŸ³æ•ˆ
                this.sounds.achievement = () => {
                    if (!this.enabled) return;
                    const now = this.audioContext.currentTime;
                    
                    // åˆ›å»ºå’Œå£°
                    const frequencies = [523.25, 659.25, 783.99]; // C, E, G
                    
                    frequencies.forEach((freq, index) => {
                        const oscillator = this.audioContext.createOscillator();
                        const gainNode = this.audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(this.audioContext.destination);
                        
                        oscillator.frequency.setValueAtTime(freq, now + index * 0.1);
                        oscillator.type = 'sine';
                        
                        gainNode.gain.setValueAtTime(0, now + index * 0.1);
                        gainNode.gain.linearRampToValueAtTime(this.volume * 0.3, now + index * 0.1 + 0.05);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + index * 0.1 + 0.5);
                        
                        oscillator.start(now + index * 0.1);
                        oscillator.stop(now + index * 0.1 + 0.5);
                    });
                };
            }
            
            play(soundName) {
                if (this.sounds[soundName]) {
                    // ç¢ºä¿éŸ³é »ä¸Šä¸‹æ–‡å·²å•Ÿå‹•
                    if (this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }
                    this.sounds[soundName]();
                }
            }
            
            setVolume(level) {
                this.volume = Math.max(0, Math.min(1, level));
            }
            
            toggle() {
                this.enabled = !this.enabled;
                return this.enabled;
            }
        }
        
        // åˆå§‹åŒ–éŸ³æ•ˆç®¡ç†å™¨
        const audioManager = new AudioManager();
        
        // è·å–Canvaså…ƒç´ å’Œä¸Šä¸‹æ–‡
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
// æ¸¸æˆå˜é‡
        let snake = [];
        let food = {};
        let gridSize = 20;
        let direction = 'right';
        let nextDirection = 'right';
        let gameSpeed = 120; // æ¯«ç§’
        let lastUpdate = 0;
        let animationId = null;
        let score = 0;
        let highScore = localStorage.getItem('snakeHighScore') || 0;
        let gameRunning = false;
        let gamePaused = false;
        
        // æ€§èƒ½ä¼˜åŒ–ç›¸å…³
        let frameCount = 0;
        let lastFpsUpdate = 0;
        let fps = 0;
        let particles = [];
        let needsRedraw = true;
        
        // æˆå°±ç³»ç»Ÿç›¸å…³
        let achievements = {
            firstScore: {
                id: 'firstScore',
                name: 'åˆæ¬¡å¾—åˆ†',
                description: 'è·å¾—ä½ çš„ç¬¬ä¸€ä¸ª10åˆ†',
                icon: 'ğŸ¯',
                unlocked: false,
                check: (stats) => stats.totalScore >= 10
            },
            score50: {
                id: 'score50',
                name: 'å°æœ‰æˆå°±',
                description: 'å•å±€æ¸¸æˆè·å¾—50åˆ†',
                icon: 'ğŸŒŸ',
                unlocked: false,
                check: (stats) => stats.maxScore >= 50
            },
            score100: {
                id: 'score100',
                name: 'æ¸¸æˆé«˜æ‰‹',
                description: 'å•å±€æ¸¸æˆè·å¾—100åˆ†',
                icon: 'â­',
                unlocked: false,
                check: (stats) => stats.maxScore >= 100
            },
            score500: {
                id: 'score500',
                name: 'è›‡ç‹ä¼ è¯´',
                description: 'å•å±€æ¸¸æˆè·å¾—500åˆ†',
                icon: 'ğŸ‘‘',
                unlocked: false,
                check: (stats) => stats.maxScore >= 500
            },
            speedDemon: {
                id: 'speedDemon',
                name: 'æé€ŸæŒ‘æˆ˜',
                description: 'æ¸¸æˆé€Ÿåº¦è¾¾åˆ°æœ€å¤§',
                icon: 'âš¡',
                unlocked: false,
                check: (stats) => stats.maxSpeed >= 180
            },
            survivor: {
                id: 'survivor',
                name: 'ç”Ÿå­˜å¤§å¸ˆ',
                description: 'æ¸¸æˆæ—¶é•¿è¶…è¿‡5åˆ†é’Ÿ',
                icon: 'â±ï¸',
                unlocked: false,
                check: (stats) => stats.maxPlayTime >= 300
            },
            collector: {
                id: 'collector',
                name: 'æ”¶é›†å®¶',
                description: 'ç´¯è®¡åƒåˆ°100ä¸ªé£Ÿç‰©',
                icon: 'ğŸ',
                unlocked: false,
                check: (stats) => stats.totalFood >= 100
            },
            perfectionist: {
                id: 'perfectionist',
                name: 'å®Œç¾ä¸»ä¹‰è€…',
                description: 'åœ¨ä¸å¤±è¯¯çš„æƒ…å†µä¸‹è¿ç»­è·å¾—50åˆ†',
                icon: 'ğŸ’',
                unlocked: false,
                check: (stats) => stats.perfectScore >= 50
            },
            veteran: {
                id: 'veteran',
                name: 'èµ„æ·±ç©å®¶',
                description: 'æ¸¸æˆæ€»æ¬¡æ•°è¾¾åˆ°50æ¬¡',
                icon: 'ğŸ–ï¸',
                unlocked: false,
                check: (stats) => stats.totalGames >= 50
            },
        };
        
        // æ¸¸æˆç»Ÿè®¡æ•°æ®
        let gameStats = {
            totalScore: 0,
            maxScore: 0,
            totalFood: 0,
            totalGames: 0,
            maxSpeed: 120,
            maxPlayTime: 0,
            perfectScore: 0,
            currentStreak: 0,
            gameStartTime: 0
        };
        
        // æ–°æˆå°±è®¡æ•°å™¨
        let newAchievementsCount = 0;
        
// DOMå…ƒç´ 
        const scoreElement = document.getElementById('score');
        const highScoreElement = document.getElementById('highScore');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const restartBtn = document.getElementById('restartBtn');
        const restartBtn2 = document.getElementById('restartBtn2');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const finalScoreElement = document.getElementById('finalScore');
        const controlsOverlay = document.getElementById('controlsOverlay');
        const closeControls = document.getElementById('closeControls');
        const keyboardHint = document.getElementById('keyboardHint');
        const achievementsBtn = document.getElementById('achievementsBtn');
        const achievementsPanel = document.getElementById('achievementsPanel');
        const closeAchievements = document.getElementById('closeAchievements');
        const achievementPopup = document.getElementById('achievementPopup');
        const achievementTitle = document.getElementById('achievementTitle');
        const achievementDesc = document.getElementById('achievementDesc');
        const achievementsList = document.getElementById('achievementsList');
        
// ç§»åŠ¨æ§åˆ¶æŒ‰é’®
        const upBtn = document.getElementById('upBtn');
        const downBtn = document.getElementById('downBtn');
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        const gestureArea = document.getElementById('gestureArea');
        
        // æ‰‹åŠ¿æ§åˆ¶ç›¸å…³
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        let minSwipeDistance = 30;
        
// æ˜¾ç¤º/éšè—æ§åˆ¶è¯´æ˜
        function toggleControlsOverlay() {
            controlsOverlay.classList.toggle('show');
            if (!controlsOverlay.classList.contains('show')) {
                keyboardHint.classList.add('show');
                setTimeout(() => keyboardHint.classList.remove('show'), 2000);
            }
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            // åˆå§‹åŒ–è›‡ - 3ä¸ªèº«ä½“éƒ¨åˆ†
            snake = [
                {x: 5 * gridSize, y: 10 * gridSize},
                {x: 4 * gridSize, y: 10 * gridSize},
                {x: 3 * gridSize, y: 10 * gridSize}
            ];
            
            // åˆå§‹åŒ–é£Ÿç‰©
            generateFood();
            
            // é‡ç½®æ–¹å‘å’Œåˆ†æ•°
            direction = 'right';
            nextDirection = 'right';
            score = 0;
            scoreElement.textContent = score;
            highScoreElement.textContent = highScore;
            
            // éšè—æ¸¸æˆç»“æŸå±å¹•
            gameOverScreen.style.display = 'none';
            
            // ç»˜åˆ¶åˆå§‹çŠ¶æ€
            draw();
            
            // é¦–æ¬¡åŠ è½½æ—¶æ˜¾ç¤ºæ§åˆ¶è¯´æ˜
            if (!localStorage.getItem('snakeControlsShown')) {
                setTimeout(() => {
                    controlsOverlay.classList.add('show');
                    localStorage.setItem('snakeControlsShown', 'true');
                }, 500);
            } else {
                // æ˜¾ç¤ºå¿«æ·é”®æç¤º
                keyboardHint.classList.add('show');
                setTimeout(() => keyboardHint.classList.remove('show'), 3000);
            }
        }
        
        // ç”Ÿæˆé£Ÿç‰©
        function generateFood() {
            // ç¡®ä¿é£Ÿç‰©ä¸å‡ºç°åœ¨è›‡èº«ä¸Š
            let foodOnSnake;
            do {
                foodOnSnake = false;
                food = {
                    x: Math.floor(Math.random() * (canvas.width / gridSize)) * gridSize,
                    y: Math.floor(Math.random() * (canvas.height / gridSize)) * gridSize
                };
                
                // æ£€æŸ¥é£Ÿç‰©æ˜¯å¦åœ¨è›‡èº«ä¸Š
                for (let segment of snake) {
                    if (segment.x === food.x && segment.y === food.y) {
                        foodOnSnake = true;
                        break;
                    }
                }
            } while (foodOnSnake);
        }
        
// ç»˜åˆ¶æ¸¸æˆå…ƒç´ 
        function draw() {
            // æ¸…é™¤ç”»å¸ƒ
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶ç½‘æ ¼çº¿ï¼ˆæ¯éš”å‡ å¸§ç»˜åˆ¶ä¸€æ¬¡ä»¥æé«˜æ€§èƒ½ï¼‰
            if (frameCount % 3 === 0) {
                drawGrid();
            }
            
            // ç»˜åˆ¶è›‡
            for (let i = 0; i < snake.length; i++) {
                // è›‡å¤´é¢œè‰²ä¸åŒ
                if (i === 0) {
                    ctx.fillStyle = '#4CAF50'; // å¤´éƒ¨ç»¿è‰²
                } else {
                    // èº«ä½“æ¸å˜è‰²
                    const greenValue = Math.max(100, 255 - i * 15);
                    ctx.fillStyle = `rgb(76, ${greenValue}, 80)`;
                }
                
                ctx.fillRect(snake[i].x, snake[i].y, gridSize, gridSize);
                
                // è›‡èº«ä½“è¾¹æ¡†
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 1;
                ctx.strokeRect(snake[i].x, snake[i].y, gridSize, gridSize);
                
                // ç»˜åˆ¶è›‡çœ¼ç›ï¼ˆå¤´éƒ¨ï¼‰
                if (i === 0) {
                    ctx.fillStyle = '#000';
                    // æ ¹æ®æ–¹å‘ç¡®å®šçœ¼ç›ä½ç½®
                    let eye1X, eye1Y, eye2X, eye2Y;
                    
                    switch(direction) {
                        case 'right':
                            eye1X = snake[i].x + gridSize - 5;
                            eye1Y = snake[i].y + 5;
                            eye2X = snake[i].x + gridSize - 5;
                            eye2Y = snake[i].y + gridSize - 5;
                            break;
                        case 'left':
                            eye1X = snake[i].x + 5;
                            eye1Y = snake[i].y + 5;
                            eye2X = snake[i].x + 5;
                            eye2Y = snake[i].y + gridSize - 5;
                            break;
                        case 'up':
                            eye1X = snake[i].x + 5;
                            eye1Y = snake[i].y + 5;
                            eye2X = snake[i].x + gridSize - 5;
                            eye2Y = snake[i].y + 5;
                            break;
                        case 'down':
                            eye1X = snake[i].x + 5;
                            eye1Y = snake[i].y + gridSize - 5;
                            eye2X = snake[i].x + gridSize - 5;
                            eye2Y = snake[i].y + gridSize - 5;
                            break;
                    }
                    
                    ctx.beginPath();
                    ctx.arc(eye1X, eye1Y, 2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.beginPath();
                    ctx.arc(eye2X, eye2Y, 2, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
// ç»˜åˆ¶é£Ÿç‰©ï¼ˆçº¢è‰²è‹¹æœï¼‰
            ctx.fillStyle = '#ff4444';
            ctx.beginPath();
            ctx.arc(
                food.x + gridSize/2, 
                food.y + gridSize/2, 
                gridSize/2 - 2, 
                0, 
                Math.PI * 2
            );
            ctx.fill();
            
            // ç»˜åˆ¶è‹¹æœèŒ
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(food.x + gridSize/2 - 1, food.y + 2, 2, 5);
            
            // ç»˜åˆ¶è‹¹æœå¶å­
            ctx.fillStyle = '#4CAF50';
            ctx.beginPath();
            ctx.ellipse(
                food.x + gridSize/2 + 4, 
                food.y + 4, 
                3, 2, 0, 0, Math.PI * 2
            );
            ctx.fill();
            
            // ç»˜åˆ¶ç²’å­æ•ˆæœ
            updateParticles();
            particles.forEach(particle => particle.draw(ctx));
        }
        
        // ç»˜åˆ¶ç½‘æ ¼çº¿
        function drawGrid() {
            ctx.strokeStyle = '#222';
            ctx.lineWidth = 0.5;
            
            // å‚ç›´çº¿
            for (let x = 0; x <= canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            // æ°´å¹³çº¿
            for (let y = 0; y <= canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }
        
        // æ›´æ–°æ¸¸æˆçŠ¶æ€
        function update() {
            // æ›´æ–°è›‡çš„æ–¹å‘
            direction = nextDirection;
            
            // æ ¹æ®æ–¹å‘ç§»åŠ¨è›‡å¤´
            let head = {x: snake[0].x, y: snake[0].y};
            
            switch(direction) {
                case 'right':
                    head.x += gridSize;
                    break;
                case 'left':
                    head.x -= gridSize;
                    break;
                case 'up':
                    head.y -= gridSize;
                    break;
                case 'down':
                    head.y += gridSize;
                    break;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ’å¢™
            if (
                head.x < 0 || 
                head.x >= canvas.width || 
                head.y < 0 || 
                head.y >= canvas.height
            ) {
                gameOver();
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ’åˆ°è‡ªå·±
            for (let segment of snake) {
                if (head.x === segment.x && head.y === segment.y) {
                    gameOver();
                    return;
                }
            }
            
            // å°†æ–°å¤´éƒ¨æ·»åŠ åˆ°è›‡
            snake.unshift(head);
            
// æ£€æŸ¥æ˜¯å¦åƒåˆ°é£Ÿç‰©
            if (head.x === food.x && head.y === food.y) {
                // æ’­æ”¾åƒé£Ÿç‰©éŸ³æ•ˆ
                audioManager.play('eat');
                
                // åˆ›å»ºç²’å­æ•ˆæœ
                createParticles(
                    food.x + gridSize/2, 
                    food.y + gridSize/2, 
                    '#4CAF50', 
                    15
                );
                
                // æ›´æ–°ç»Ÿè®¡
                gameStats.totalFood++;
                gameStats.perfectScore = Math.max(gameStats.perfectScore, score);
                
                // å¢åŠ åˆ†æ•°
                score += 10;
                scoreElement.textContent = score;
                
                // æ¯å¾—50åˆ†å¢åŠ é€Ÿåº¦
                if (score % 50 === 0 && gameSpeed > 50) {
                    gameSpeed -= 10;
                    clearInterval(gameLoop);
                    gameLoop = setInterval(gameStep, gameSpeed);
                }
                
                // ç”Ÿæˆæ–°é£Ÿç‰©
                generateFood();
            } else {
                // å¦‚æœæ²¡æœ‰åƒåˆ°é£Ÿç‰©ï¼Œç§»é™¤å°¾éƒ¨
                snake.pop();
            }
            
            // ç»˜åˆ¶æ›´æ–°åçš„æ¸¸æˆçŠ¶æ€
            draw();
        }
        
// æ›´æ–°ç²’å­
        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const particle = particles[i];
                particle.update();
                
                if (particle.life <= 0) {
                    particles.splice(i, 1);
                }
            }
        }
        
// æ¸¸æˆç»“æŸ
        function gameOver() {
            gameRunning = false;
            
            // æ’­æ”¾éŠæˆ²çµæŸéŸ³æ•ˆ
            audioManager.play('gameOver');
            
            // åˆ›å»ºçˆ†ç‚¸ç²’å­æ•ˆæœ
            if (snake.length > 0) {
                const head = snake[0];
                createParticles(head.x + gridSize/2, head.y + gridSize/2, '#ff4444', 20);
                draw(); // æœ€åç»˜åˆ¶ä¸€æ¬¡ä»¥æ˜¾ç¤ºæ•ˆæœ
            }
            
            // æ¸…ç†åŠ¨ç”»
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            // æ›´æ–°æ¸¸æˆç»Ÿè®¡
            updateGameStats();
            
            // æ›´æ–°æœ€é«˜åˆ†
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('snakeHighScore', highScore);
                highScoreElement.textContent = highScore;
            }
            
            // æ£€æŸ¥æˆå°±
            checkAchievements();
            saveAchievements();
            
            // æ˜¾ç¤ºæ¸¸æˆç»“æŸå±å¹•
            finalScoreElement.textContent = score;
            gameOverScreen.style.display = 'flex';
        }
        
// ç²’å­ç³»ç»Ÿ
        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.vx = (Math.random() - 0.5) * 4;
                this.vy = (Math.random() - 0.5) * 4;
                this.life = 1.0;
                this.decay = 0.02;
            }
            
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.life -= this.decay;
                this.vx *= 0.98;
                this.vy *= 0.98;
            }
            
            draw(ctx) {
                ctx.save();
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, 4, 4);
                ctx.restore();
            }
        }
        
        // åˆ›å»ºç²’å­æ•ˆæœ
        function createParticles(x, y, color, count = 10) {
            for (let i = 0; i < count; i++) {
                particles.push(new Particle(x, y, color));
            }
        }
        
        // ä¼˜åŒ–çš„æ¸¸æˆå¾ªç¯
        function gameLoop(currentTime) {
            if (!gameRunning) return;
            
            // FPSè®¡ç®—
            frameCount++;
            if (currentTime - lastFpsUpdate >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastFpsUpdate = currentTime;
            }
            
            if (!gamePaused) {
                if (currentTime - lastUpdate >= gameSpeed) {
                    update();
                    lastUpdate = currentTime;
                    needsRedraw = true;
                }
            }
            
            // åªåœ¨éœ€è¦æ—¶é‡ç»˜
            if (needsRedraw || particles.length > 0) {
                draw();
                needsRedraw = false;
            }
            
            animationId = requestAnimationFrame(gameLoop);
        }
        
        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            audioManager.play('button');
            if (!gameRunning) {
                gameRunning = true;
                gamePaused = false;
                pauseBtn.textContent = 'æš‚åœæ¸¸æˆ';
                
                // è®°å½•æ¸¸æˆå¼€å§‹æ—¶é—´
                gameStats.gameStartTime = Date.now();
                
                // å¦‚æœè›‡ä¸ºç©ºï¼Œåˆå§‹åŒ–æ¸¸æˆ
                if (snake.length === 0) {
                    initGame();
                }
                
                // å¯åŠ¨ä¼˜åŒ–çš„æ¸¸æˆå¾ªç¯
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
                lastUpdate = performance.now();
                animationId = requestAnimationFrame(gameLoop);
            }
        }
        
// æš‚åœ/ç»§ç»­æ¸¸æˆ
        function togglePause() {
            if (!gameRunning) return;
            
            audioManager.play('pause');
            gamePaused = !gamePaused;
            pauseBtn.textContent = gamePaused ? 'ç»§ç»­æ¸¸æˆ' : 'æš‚åœæ¸¸æˆ';
            needsRedraw = true;
        }
        
// é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            audioManager.play('button');
            
            // æ¸…ç†ç°æœ‰åŠ¨ç”»
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            // æ¸…ç†ç²’å­
            particles = [];
            
            initGame();
            gameRunning = true;
            gamePaused = false;
            pauseBtn.textContent = 'æš‚åœæ¸¸æˆ';
            
            // å¯åŠ¨æ–°çš„æ¸¸æˆå¾ªç¯
            lastUpdate = performance.now();
            animationId = requestAnimationFrame(gameLoop);
        }
        
// æ£€æµ‹ç§»åŠ¨è®¾å¤‡
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   (window.innerWidth <= 768 && 'ontouchstart' in window);
        }
        
        // ç§»åŠ¨ç«¯ä¼˜åŒ–
        if (isMobileDevice()) {
            // è®¾ç½®è§†å£
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
            }
            
            // æ·»åŠ ç§»åŠ¨ç«¯æ ·å¼ç±»
            document.body.classList.add('mobile-device');
            
            // éšè—é”®ç›˜æç¤º
            keyboardHint.style.display = 'none';
            
            // æ˜¾ç¤ºç§»åŠ¨ç«¯æç¤º
            const mobileHint = document.getElementById('mobileHint');
            if (mobileHint) {
                mobileHint.style.display = 'block';
                setTimeout(() => {
                    mobileHint.style.display = 'none';
                }, 3000);
            }
            
            // è°ƒæ•´æ¸¸æˆé€Ÿåº¦ï¼ˆç§»åŠ¨ç«¯é€šå¸¸å“åº”è¾ƒæ…¢ï¼‰
            gameSpeed = 150;
        }
        
        // é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case 'ArrowUp':
                    if (direction !== 'down') {
                        nextDirection = 'up';
                        audioManager.play('move');
                    }
                    e.preventDefault();
                    break;
                case 'ArrowDown':
                    if (direction !== 'up') {
                        nextDirection = 'down';
                        audioManager.play('move');
                    }
                    e.preventDefault();
                    break;
                case 'ArrowLeft':
                    if (direction !== 'right') {
                        nextDirection = 'left';
                        audioManager.play('move');
                    }
                    e.preventDefault();
                    break;
                case 'ArrowRight':
                    if (direction !== 'left') {
                        nextDirection = 'right';
                        audioManager.play('move');
                    }
                    e.preventDefault();
                    break;
                case ' ':
                case 'Space':
                    togglePause();
                    e.preventDefault();
                    break;
                case 'r':
                case 'R':
                    restartGame();
                    e.preventDefault();
                    break;
                case 'h':
                case 'H':
                    toggleControlsOverlay();
                    e.preventDefault();
                    break;
                case 'm':
                case 'M':
                    audioControl.click();
                    e.preventDefault();
                    break;
                case 'a':
                case 'A':
                    achievementsBtn.click();
                    e.preventDefault();
                    break;
            }
        });
        
// æŒ‰é’®äº‹ä»¶ç›‘å¬
        startBtn.addEventListener('click', startGame);
        pauseBtn.addEventListener('click', togglePause);
        restartBtn.addEventListener('click', restartGame);
        restartBtn2.addEventListener('click', restartGame);
        
        // æ§åˆ¶è¦†å±¤äº‹ä»¶
        closeControls.addEventListener('click', () => {
            controlsOverlay.classList.remove('show');
            audioManager.play('button');
            startGame();
        });
        
        // æˆå°±é¢æ¿äº‹ä»¶
        achievementsBtn.addEventListener('click', () => {
            achievementsPanel.classList.add('show');
            newAchievementsCount = 0;
            updateAchievementsButton();
            audioManager.play('button');
        });
        
        closeAchievements.addEventListener('click', () => {
            achievementsPanel.classList.remove('show');
            audioManager.play('button');
        });
        
// ç§»åŠ¨æ§åˆ¶æŒ‰é’®äº‹ä»¶
        upBtn.addEventListener('click', () => { 
            if (direction !== 'down') {
                nextDirection = 'up';
                audioManager.play('move');
            }
        });
        downBtn.addEventListener('click', () => { 
            if (direction !== 'up') {
                nextDirection = 'down';
                audioManager.play('move');
            }
        });
        leftBtn.addEventListener('click', () => { 
            if (direction !== 'right') {
                nextDirection = 'left';
                audioManager.play('move');
            }
        });
        rightBtn.addEventListener('click', () => { 
            if (direction !== 'left') {
                nextDirection = 'right';
                audioManager.play('move');
            }
        });
        
        // è§¦æ‘¸æ§åˆ¶ï¼ˆé˜²æ­¢æ»‘åŠ¨é¡µé¢ï¼‰
        upBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (direction !== 'down') {
                nextDirection = 'up';
                audioManager.play('move');
            }
        });
        
        downBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (direction !== 'up') {
                nextDirection = 'down';
                audioManager.play('move');
            }
        });
        
        leftBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (direction !== 'right') {
                nextDirection = 'left';
                audioManager.play('move');
            }
        });
        
        rightBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (direction !== 'left') {
                nextDirection = 'right';
                audioManager.play('move');
            }
        });
        
        // æ‰‹åŠ¿æ§åˆ¶äº‹ä»¶å¤„ç†
        function handleGestureStart(e) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }
        
        function handleGestureEnd(e) {
            touchEndX = e.changedTouches[0].clientX;
            touchEndY = e.changedTouches[0].clientY;
            handleSwipeGesture();
        }
        
        function handleSwipeGesture() {
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            const absDeltaX = Math.abs(deltaX);
            const absDeltaY = Math.abs(deltaY);
            
            // ç¡®å®šæ»‘åŠ¨æ–¹å‘
            if (Math.max(absDeltaX, absDeltaY) > minSwipeDistance) {
                if (absDeltaX > absDeltaY) {
                    // æ°´å¹³æ»‘åŠ¨
                    if (deltaX > 0) {
                        // å‘å³æ»‘åŠ¨
                        if (direction !== 'left') {
                            nextDirection = 'right';
                            audioManager.play('move');
                        }
                    } else {
                        // å‘å·¦æ»‘åŠ¨
                        if (direction !== 'right') {
                            nextDirection = 'left';
                            audioManager.play('move');
                        }
                    }
                } else {
                    // å‚ç›´æ»‘åŠ¨
                    if (deltaY > 0) {
                        // å‘ä¸‹æ»‘åŠ¨
                        if (direction !== 'up') {
                            nextDirection = 'down';
                            audioManager.play('move');
                        }
                    } else {
                        // å‘ä¸Šæ»‘åŠ¨
                        if (direction !== 'down') {
                            nextDirection = 'up';
                            audioManager.play('move');
                        }
                    }
                }
            }
        }
        
        // æ·»åŠ æ‰‹åŠ¿äº‹ä»¶ç›‘å¬å™¨
        gestureArea.addEventListener('touchstart', handleGestureStart, { passive: true });
        gestureArea.addEventListener('touchend', handleGestureEnd, { passive: true });
        
        // ä¸ºæ•´ä¸ªæ¸¸æˆåŒºåŸŸæ·»åŠ æ‰‹åŠ¿æ”¯æŒï¼ˆç§»åŠ¨ç«¯ï¼‰
        if ('ontouchstart' in window) {
            canvas.addEventListener('touchstart', handleGestureStart, { passive: true });
            canvas.addEventListener('touchend', handleGestureEnd, { passive: true });
        }
        
        // é˜²æ­¢ç§»åŠ¨ç«¯åŒå‡»ç¼©æ”¾
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // é˜²æ­¢ç§»åŠ¨ç«¯æ»šåŠ¨
        document.body.addEventListener('touchmove', (e) => {
            if (e.target === canvas || e.target === gestureArea) {
                e.preventDefault();
            }
        }, { passive: false });
        
// éŸ³æ•ˆæ§åˆ¶æŒ‰é’®åŠŸèƒ½
        const audioControl = document.getElementById('audioControl');
        
        // åˆå§‹åŒ–éŸ³æ•ˆæ§åˆ¶çŠ¶æ€
        const savedAudioState = localStorage.getItem('snakeAudioEnabled');
        if (savedAudioState !== null) {
            audioManager.enabled = savedAudioState === 'true';
        }
        
        // æ›´æ–°éŸ³æ•ˆæ§åˆ¶UI
        function updateAudioControlUI() {
            if (audioManager.enabled) {
                audioControl.classList.remove('muted');
            } else {
                audioControl.classList.add('muted');
            }
        }
        
        // éŸ³æ•ˆæ§åˆ¶æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        audioControl.addEventListener('click', () => {
            audioManager.toggle();
            localStorage.setItem('snakeAudioEnabled', audioManager.enabled);
            updateAudioControlUI();
            audioManager.play('button'); // æ’­æ”¾æŒ‰é’®éŸ³æ•ˆæ¥æµ‹è¯•
        });
        
        // åˆå§‹åŒ–éŸ³æ•ˆæ§åˆ¶UI
        updateAudioControlUI();
        
        // æˆå°±ç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½
        function loadAchievements() {
            const saved = localStorage.getItem('snakeAchievements');
            if (saved) {
                const savedAchievements = JSON.parse(saved);
                Object.keys(savedAchievements).forEach(id => {
                    if (achievements[id]) {
                        achievements[id].unlocked = savedAchievements[id].unlocked;
                    }
                });
            }
            
            const savedStats = localStorage.getItem('snakeGameStats');
            if (savedStats) {
                gameStats = { ...gameStats, ...JSON.parse(savedStats) };
            }
            
            updateAchievementsUI();
        }
        
        function saveAchievements() {
            const toSave = {};
            Object.keys(achievements).forEach(id => {
                toSave[id] = {
                    unlocked: achievements[id].unlocked
                };
            });
            localStorage.setItem('snakeAchievements', JSON.stringify(toSave));
            localStorage.setItem('snakeGameStats', JSON.stringify(gameStats));
        }
        
        function checkAchievements() {
            let newUnlock = false;
            
            Object.values(achievements).forEach(achievement => {
                if (!achievement.unlocked && achievement.check(gameStats)) {
                    achievement.unlocked = true;
                    showAchievementPopup(achievement);
                    newUnlock = true;
                    newAchievementsCount++;
                }
            });
            
            if (newUnlock) {
                updateAchievementsUI();
                saveAchievements();
                updateAchievementsButton();
            }
        }
        
        function showAchievementPopup(achievement) {
            audioManager.play('achievement');
            
            const popup = document.getElementById('achievementPopup');
            document.getElementById('achievementTitle').textContent = achievement.name;
            document.getElementById('achievementDesc').textContent = achievement.description;
            
            popup.classList.add('show');
            
            setTimeout(() => {
                popup.classList.remove('show');
            }, 3000);
        }
        
        function updateAchievementsUI() {
            const list = document.getElementById('achievementsList');
            list.innerHTML = '';
            
            Object.values(achievements).forEach(achievement => {
                const item = document.createElement('div');
                item.className = `achievement-item ${achievement.unlocked ? 'unlocked' : 'locked'}`;
                
                const progress = getAchievementProgress(achievement);
                
                item.innerHTML = `
                    <div class="achievement-item-icon">${achievement.icon}</div>
                    <div class="achievement-item-info">
                        <h4>${achievement.name}</h4>
                        <p>${achievement.description}</p>
                        ${progress.current < progress.total ? `
                            <div class="achievement-progress">
                                <div class="achievement-progress-bar" style="width: ${(progress.current / progress.total) * 100}%"></div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                list.appendChild(item);
            });
        }
        
        function getAchievementProgress(achievement) {
            // è®¡ç®—æˆå°±è¿›åº¦
            switch(achievement.id) {
                case 'firstScore': return { current: gameStats.totalScore, total: 10 };
                case 'score50': return { current: gameStats.maxScore, total: 50 };
                case 'score100': return { current: gameStats.maxScore, total: 100 };
                case 'score500': return { current: gameStats.maxScore, total: 500 };
                case 'speedDemon': return { current: gameStats.maxSpeed, total: 180 };
                case 'survivor': return { current: gameStats.maxPlayTime, total: 300 };
                case 'collector': return { current: gameStats.totalFood, total: 100 };
                case 'perfectionist': return { current: gameStats.perfectScore, total: 50 };
                case 'veteran': return { current: gameStats.totalGames, total: 50 };
                default: return { current: 0, total: 1 };
            }
        }
        
        function updateAchievementsButton() {
            const btn = document.getElementById('achievementsBtn');
            if (newAchievementsCount > 0) {
                btn.classList.add('has-new');
            } else {
                btn.classList.remove('has-new');
            }
        }
        
        function updateGameStats() {
            // æ›´æ–°æ¸¸æˆç»Ÿè®¡
            gameStats.totalScore += score;
            gameStats.maxScore = Math.max(gameStats.maxScore, score);
            gameStats.totalGames++;
            gameStats.maxSpeed = Math.max(gameStats.maxSpeed, 210 - gameSpeed); // é€Ÿåº¦è¶Šé«˜ï¼Œæ•°å€¼è¶Šå¤§
            
            // æ›´æ–°æ¸¸æˆæ—¶é•¿
            if (gameStats.gameStartTime > 0) {
                const playTime = Math.floor((Date.now() - gameStats.gameStartTime) / 1000);
                gameStats.maxPlayTime = Math.max(gameStats.maxPlayTime, playTime);
            }
        }
        
        // é”™è¯¯å¤„ç†
        window.addEventListener('error', (e) => {
            console.error('æ¸¸æˆé”™è¯¯:', e.error);
            audioManager.enabled = false; // å‘ç”Ÿé”™è¯¯æ—¶ç¦ç”¨éŸ³æ•ˆ
        });
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', () => {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            if (audioManager.audioContext) {
                audioManager.audioContext.close();
            }
        });
        
        // åˆå§‹åŒ–æˆå°±ç³»ç»Ÿ
        loadAchievements();
        
        // åˆå§‹åŒ–æ¸¸æˆï¼ˆä½†ä¸å¼€å§‹ï¼‰
        initGame();
        draw();
        
        // æ˜¾ç¤ºåˆå§‹è¯´æ˜
        console.log("æ¸¸æˆå·²åŠ è½½ï¼ä½¿ç”¨æ–¹å‘é”®æ§åˆ¶è›‡çš„ç§»åŠ¨ã€‚");
        console.log("åƒåˆ°çº¢è‰²è‹¹æœå¯ä»¥å¢åŠ åˆ†æ•°å¹¶ä½¿è›‡å˜é•¿ã€‚");
        console.log("æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨ requestAnimationFrame å’Œç²’å­ç³»ç»Ÿ");
        console.log("æˆå°±ç³»ç»Ÿï¼šæŒ‰ A æŸ¥çœ‹æˆå°±ï¼ŒåŠªåŠ›è§£é”æ‰€æœ‰æˆå°±ï¼");
    </script>
</body>
</html>