<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ÁØÄÂ•èÂ§ßÂ∏´ - Technical Ver.</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='50%' x='50%' font-size='50' text-anchor='middle' dominant-baseline='middle'>üéµ</text></svg>">
    <style>
        body { 
            margin: 0; background: #000; 
            font-family: 'Courier New', monospace; 
            overflow: hidden; display: flex; justify-content: center; align-items: center; 
            height: 100vh; color: #fff; user-select: none; 
        }
        
        #game-container {
            position: relative; width: 100%; max-width: 600px; height: 100%;
            background: linear-gradient(180deg, #1a1a1a 0%, #000 100%);
            border-left: 1px solid #444; border-right: 1px solid #444;
        }

        canvas { display: block; width: 100%; height: 100%; }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; align-items: center;
        }

        #score {
            margin-top: 20px; font-size: 24px; font-weight: bold; letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        #combo-container {
            position: absolute; bottom: 30%; text-align: center;
        }
        #combo-val { font-size: 70px; font-weight: 800; color: rgba(255,255,255,0.2); }
        #combo-label { font-size: 14px; color: #888; letter-spacing: 5px; text-transform: uppercase; }

        /* Cinematic Bars */
        .cinema-bar {
            position: absolute; left: 0; width: 100%; height: 0; background: #000; z-index: 10; transition: height 1s;
        }
        #top-bar { top: 0; }
        #bottom-bar { bottom: 0; }

        /* Start Screen */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        
        h1 { font-size: 28px; letter-spacing: 6px; margin-bottom: 5px; text-transform: uppercase; }
        .sub { font-size: 12px; color: #666; margin-bottom: 40px; letter-spacing: 2px; }
        
        .key-guide { display: flex; gap: 20px; margin-bottom: 40px; }
        .k { width: 40px; height: 40px; border: 1px solid #444; display: flex; justify-content: center; align-items: center; color: #888; border-radius: 5px; }

        button {
            padding: 15px 50px; background: #fff; color: #000; border: none;
            font-size: 16px; font-weight: bold; letter-spacing: 2px; cursor: pointer;
            transition: 0.2s;
        }
button:hover { transform: scale(1.1); box-shadow: 0 0 20px #fff; }
        
        /* Audio Control Styles */
        .audio-control {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 1000;
            color: white;
            font-size: 1.5rem;
        }
        
        .audio-control:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .audio-control.muted {
            background: rgba(255, 68, 68, 0.3);
            border-color: rgba(255, 68, 68, 0.5);
        }
        
        /* Mobile Touch Controls */
        .mobile-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            grid-template-columns: repeat(4, 60px);
            gap: 10px;
            z-index: 100;
        }
        
        .mobile-btn {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .mobile-btn:active {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0.95);
        }
        
        /* Performance Monitor */
        .fps-counter {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: #0f0;
            padding: 5px 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .mobile-controls {
                display: grid;
            }
            
            .audio-control {
                width: 45px;
                height: 45px;
                top: 15px;
                right: 15px;
                font-size: 1.3rem;
            }
            
            .key-guide {
                display: none;
            }
            
            #start-screen h1 {
                font-size: 2rem;
            }
            
            .sub {
                font-size: 0.9rem;
            }
            
            button {
                padding: 12px 40px;
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            .mobile-controls {
                bottom: 10px;
                gap: 8px;
            }
            
            .mobile-btn {
                width: 50px;
                height: 50px;
                padding: 10px;
                font-size: 1rem;
            }
            
            #score {
                font-size: 18px;
            }
            
            #combo-val {
                font-size: 50px;
            }
        }

    </style>
</head>
<body>

<div id="game-container">
    <!-- Audio Control -->
    <div class="audio-control" id="audioControl" title="ÂàáÊèõÈü≥Êïà">
        üîä
    </div>
    
    <!-- FPS Counter (for performance monitoring) -->
    <div class="fps-counter" id="fpsCounter">FPS: 60</div>
    
    <div id="top-bar" class="cinema-bar"></div>
    <div id="bottom-bar" class="cinema-bar"></div>

    <canvas id="gameCanvas"></canvas>
    
    <div id="ui-layer">
        <div id="score">000000</div>
        <div id="combo-container">
            <div id="combo-val"></div>
            <div id="combo-label"></div>
        </div>
    </div>

    <div id="start-screen">
        <h1>In Memoriam</h1>
        <div class="sub">Technical Mapping Edition</div>
        
        <div class="key-guide">
            <div class="k">D</div><div class="k">F</div>
            <div class="k">J</div><div class="k">K</div>
        </div>

<button id="start-btn">ENGAGE</button>
    </div>
    
    <!-- Mobile Touch Controls -->
    <div class="mobile-controls">
        <div class="mobile-btn" data-lane="0">D</div>
        <div class="mobile-btn" data-lane="1">F</div>
        <div class="mobile-btn" data-lane="2">J</div>
        <div class="mobile-btn" data-lane="3">K</div>
    </div>
</div>

<script>
// --- ENHANCED AUDIO ENGINE ---
const Audio = {
    ctx: null,
    out: null,
    sfxGain: null,
    musicGain: null,
    enabled: true,
    volume: 0.6,
    
    init() {
        const AC = window.AudioContext || window.webkitAudioContext;
        this.ctx = new AC();
        
        // Master gain for overall volume control
        this.out = this.ctx.createGain();
        this.out.gain.value = this.volume;
        
        // Separate gains for SFX and music
        this.sfxGain = this.ctx.createGain();
        this.sfxGain.gain.value = 0.7;
        
        this.musicGain = this.ctx.createGain();
        this.musicGain.gain.value = 0.5;
        
        // Reverb for atmosphere
        const verb = this.ctx.createConvolver();
        this.makeImpulse(verb);
        
        // Audio routing
        this.sfxGain.connect(this.out);
        this.musicGain.connect(this.out);
        this.out.connect(verb);
        verb.connect(this.ctx.destination);
        this.out.connect(this.ctx.destination);
        
        // Resume audio context for user interaction
        this.resumeContext();
    },
    
    resumeContext() {
        if (this.ctx.state === 'suspended') {
            this.ctx.resume();
        }
    },
    
    toggle() {
        this.enabled = !this.enabled;
        if (this.enabled) {
            this.out.gain.value = this.volume;
        } else {
            this.out.gain.value = 0;
        }
        return this.enabled;
    },
    
    setVolume(level) {
        this.volume = Math.max(0, Math.min(1, level));
        if (this.enabled) {
            this.out.gain.value = this.volume;
        }
    },

    makeImpulse(node) {
        const len = this.ctx.sampleRate * 2.5;
        const b = this.ctx.createBuffer(2, len, this.ctx.sampleRate);
        for(let i=0;i<len;i++) {
            const d = Math.pow(1-i/len, 3);
            b.getChannelData(0)[i] = (Math.random()*2-1)*d*0.4;
            b.getChannelData(1)[i] = (Math.random()*2-1)*d*0.4;
        }
        node.buffer = b;
    },

    playTone(freq, t) {
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.type = 'triangle';
        o.frequency.value = freq;
        
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(0.3, t+0.01);
        g.gain.exponentialRampToValueAtTime(0.001, t+0.6);
        
        o.connect(g); g.connect(this.out);
        o.start(t); o.stop(t+0.6);
    },

    // Triggered on key press: Plays a rapid arpeggio burst
    playBurst(rootFreq) {
        if (!this.enabled) return;
        const now = this.ctx.currentTime;
        // Play root + 5th + octave rapid
        [1, 1.5, 2].forEach((m, i) => {
            this.playTone(rootFreq * m, now + (i*0.05));
        });
    },
    
    // New sound effects
    playHit() {
        if (!this.enabled) return;
        const now = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        
        osc.connect(gain);
        gain.connect(this.sfxGain);
        
        osc.frequency.setValueAtTime(800, now);
        osc.frequency.exponentialRampToValueAtTime(1600, now + 0.1);
        
        gain.gain.setValueAtTime(0.3, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
        
        osc.start(now);
        osc.stop(now + 0.15);
    },
    
    playMiss() {
        if (!this.enabled) return;
        const now = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        
        osc.connect(gain);
        gain.connect(this.sfxGain);
        
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(200, now);
        osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
        
        gain.gain.setValueAtTime(0.2, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
        
        osc.start(now);
        osc.stop(now + 0.3);
    },
    
    playCombo(comboLevel) {
        if (!this.enabled) return;
        const now = this.ctx.currentTime;
        const baseFreq = 400 + (comboLevel * 50);
        
        // Harmonic chords for combos
        [1, 1.25, 1.5].forEach((m, i) => {
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            
            osc.connect(gain);
            gain.connect(this.sfxGain);
            
            osc.frequency.setValueAtTime(baseFreq * m, now + i * 0.02);
            osc.type = i === 0 ? 'sine' : 'triangle';
            
            gain.gain.setValueAtTime(0, now + i * 0.02);
            gain.gain.linearRampToValueAtTime(0.2, now + i * 0.02 + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.02 + 0.3);
            
            osc.start(now + i * 0.02);
            osc.stop(now + i * 0.02 + 0.3);
        });
    },
    
    playButton() {
        if (!this.enabled) return;
        const now = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        
        osc.connect(gain);
        gain.connect(this.sfxGain);
        
        osc.frequency.setValueAtTime(600, now);
        osc.frequency.exponentialRampToValueAtTime(400, now + 0.05);
        
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
        
        osc.start(now);
        osc.stop(now + 0.05);
    }
};

// --- MAPPING LOGIC (The Fix) ---
const N = { G:196, F:174, Eb:155, D:146 };

function generateMap() {
    let notes = [];
    let t = 2.0;
    const beat = 60 / 135; 

    // Helper: Push note
    const n = (lane, freq, timeOffset=0, type='normal') => {
        notes.push({ lane, f: freq, t: t + timeOffset, type, hit:false });
    };

    // Helper: Patterns
    // 1. Alternating (Trill)
    const trill = (f) => {
        n(1, f); n(2, f, beat*0.5); n(1, f, beat*1.0); n(2, f, beat*1.5);
        t += beat * 2;
    };
    
    // 2. Stairs Down (Gm -> Dm feel)
    const stairDown = (f) => {
        n(3, f); n(2, f, beat*0.5); n(1, f, beat*1.0); n(0, f, beat*1.5);
        t += beat * 2;
    };

    // 3. Wide Jumps (Harder)
    const jump = (f) => {
        n(0, f); n(3, f, beat*0.5); n(1, f, beat*1.0); n(2, f, beat*1.5);
        t += beat * 2;
    };

    // 4. Double (Impact)
    const double = (f) => {
        n(0, f); n(3, f); // Boom
        t += beat * 2; // Give some rest or continue
    };

    // --- SONG STRUCTURE ---

    // PART 1: INTRO (Center lanes focus)
    // 4 Bars
    for(let i=0; i<4; i++) trill(N.G);

    // PART 2: MAIN THEME (Movement)
    // Gm -> F -> Eb -> Dm
    for(let i=0; i<2; i++) {
        stairDown(N.G); // 3-2-1-0
        stairDown(N.F); 
        stairDown(N.Eb);
        stairDown(N.D);
    }

    // PART 3: TENSION (Jumps)
    // Randomize feel
    for(let i=0; i<2; i++) {
        jump(N.G); jump(N.F);
        jump(N.Eb); jump(N.D);
    }

    // PART 4: CLIMAX (Doubles & Density)
    // Heavy hits
    for(let i=0; i<2; i++) {
        // Gm
        double(N.G); n(1, N.G, beat*1.0); n(2, N.G, beat*1.5);
        // F
        double(N.F); n(1, N.F, beat*1.0); n(2, N.F, beat*1.5);
        // Eb
        double(N.Eb); n(1, N.Eb, beat*1.0); n(2, N.Eb, beat*1.5);
        // Dm
        double(N.D); n(1, N.D, beat*1.0); n(2, N.D, beat*1.5);
        
        t += beat * 2; // Fix timing accumulation from the manual 'double' function adds
    }

    // OUTRO
    n(0, N.G); n(3, N.G);

    return notes;
}

const LEVEL = generateMap();

// --- ENHANCED GAME ENGINE ---
const Game = {
    canvas: null,
    ctx: null,
    w: 600, h: 400,
    lw: 150, // Lane width
    notes: [],
    fx: [],
    hitY: 300,
    
    state: {
        score: 0,
        combo: 0,
        playing: false,
        t0: 0
    },
    
    // Performance monitoring
    fps: 60,
    frameCount: 0,
    lastFpsUpdate: 0,
    showFps: false,
    
    // Mobile detection
    isMobile: false,
    
    init() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.canvas.width = this.w;
        this.canvas.height = this.h;
        
        // Detect mobile
        this.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                      (window.innerWidth <= 768 && 'ontouchstart' in window);
        
        Audio.init();
        this.notes = generateMap();
        this.state.playing = true;
        this.state.t0 = Audio.ctx.currentTime;
        
        // Initialize UI
        this.initUI();
        
        // Initialize performance monitoring
        if (this.isMobile) {
            document.getElementById('fpsCounter').style.display = 'block';
            this.showFps = true;
        }
        
        this.lastFpsUpdate = performance.now();
    },
    
    initUI() {
        // Audio control
        const audioControl = document.getElementById('audioControl');
        audioControl.addEventListener('click', () => {
            const enabled = Audio.toggle();
            audioControl.classList.toggle('muted', !enabled);
            audioControl.textContent = enabled ? 'üîä' : 'üîá';
            Audio.playButton();
        });
        
        // Mobile touch controls
        if (this.isMobile) {
            const mobileButtons = document.querySelectorAll('.mobile-btn');
            mobileButtons.forEach(btn => {
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const lane = parseInt(btn.dataset.lane);
                    this.check(lane);
                });
                
                btn.addEventListener('click', () => {
                    const lane = parseInt(btn.dataset.lane);
                    this.check(lane);
                });
            });
        }
    },
    
    updateFPS(currentTime) {
        this.frameCount++;
        if (currentTime - this.lastFpsUpdate >= 1000) {
            this.fps = this.frameCount;
            this.frameCount = 0;
            this.lastFpsUpdate = currentTime;
            
            if (this.showFps) {
                document.getElementById('fpsCounter').textContent = `FPS: ${this.fps}`;
            }
        }
    },
        this.notes = JSON.parse(JSON.stringify(LEVEL));
        this.loop();
    },

    check(lane) {
        const now = Audio.ctx.currentTime - this.state.t0;
        // Find hit within window (0.15s = standard rhythm game tight window)
        const note = this.notes.find(n => !n.hit && n.lane === lane && Math.abs(n.t - now) < 0.2);
        
        if(note) {
            note.hit = true;
            this.state.combo++;
            this.state.score += 100 + (this.state.combo * 10);
             
            Audio.playBurst(note.f);
            Audio.playHit();
            
            // Combo sound effects every 5 combo
            if (this.state.combo % 5 === 0) {
                Audio.playCombo(Math.floor(this.state.combo / 5));
            }
             
            // FX
            this.fx.push({type:'hit', x: (lane+0.5)*this.lw, y: this.hitY, life:1});
            this.updateUI();
        } else {
            // Ghost tap handling - play miss sound but don't reset combo for forgiving gameplay
            Audio.playMiss();
        }
    },

    updateUI() {
        document.getElementById('score').innerText = this.state.score.toString().padStart(6,'0');
        const c = document.getElementById('combo-container');
        document.getElementById('combo-val').innerText = this.state.combo;
        document.getElementById('combo-label').innerText = this.state.combo > 5 ? "COMBO" : "";
        
        // Pulse effect
        c.style.transform = "scale(1.2)";
        setTimeout(() => c.style.transform = "scale(1)", 100);
    },

    loop() {
        if(!this.state.playing) return;
        const now = Audio.ctx.currentTime - this.state.t0;
        const spd = 1.3; // Speed (Lower is faster visually)

        // Clear
        this.ctx.fillStyle = '#000';
        this.ctx.fillRect(0,0,this.w,this.h);

        // Grid
        this.ctx.strokeStyle = '#333';
        this.ctx.lineWidth = 2;
        for(let i=1;i<4;i++) {
            this.ctx.beginPath(); this.ctx.moveTo(i*this.lw, 0); this.ctx.lineTo(i*this.lw, this.h); this.ctx.stroke();
        }

        // Hit Line
        this.ctx.strokeStyle = '#fff';
        this.ctx.beginPath(); this.ctx.moveTo(0, this.hitY); this.ctx.lineTo(this.w, this.hitY); this.ctx.stroke();

        // Logic & Draw Notes
        this.notes.forEach(n => {
            if(n.hit) return;
            
            // Miss check
            if(now > n.t + 0.25) {
                n.hit = true; // Gone
                if (this.state.combo > 0) {
                    Audio.playMiss();
                    this.state.combo = 0;
                    this.updateUI();
                }
                return;
            }

            const y = this.hitY - (n.t - now) * (this.hitY/spd);
            
            if(y > -50 && y < this.h) {
                // Different color for double hits visual cue?
                this.ctx.fillStyle = '#fff';
                // Note body
                this.ctx.fillRect(n.lane*this.lw + 5, y-10, this.lw-10, 20);
                
                // Trail
                const grad = this.ctx.createLinearGradient(0, y, 0, y-100);
                grad.addColorStop(0, 'rgba(255,255,255,0.3)');
                grad.addColorStop(1, 'rgba(255,255,255,0)');
                this.ctx.fillStyle = grad;
                this.ctx.fillRect(n.lane*this.lw + 5, y-100, this.lw-10, 100);
            }
        });

        // Draw FX
        this.fx.forEach((f, i) => {
            if(f.type === 'hit') {
                this.ctx.strokeStyle = `rgba(255,255,255,${f.life})`;
                this.ctx.lineWidth = 3;
                this.ctx.beginPath();
                this.ctx.arc(f.x, f.y, (1-f.life)*50, 0, Math.PI*2);
                this.ctx.stroke();
            } else if (f.type === 'lane') {
                this.ctx.fillStyle = `rgba(255,255,255,${f.life * 0.2})`;
                this.ctx.fillRect(f.lane*this.lw, 0, this.lw, this.h);
            }
            f.life -= 0.1;
        });
        this.fx = this.fx.filter(f => f.life > 0);

        if(now > 35) { // End of snippet
             this.state.playing = false;
             alert("Section Complete. Score: " + this.state.score);
             location.reload();
        }

                // Update performance monitoring
        this.updateFPS(performance.now());
        
        requestAnimationFrame(() => this.loop());
    }
};

// Enhanced input binding
window.addEventListener('keydown', (e) => {
    // Resume audio context on first interaction
    Audio.resumeContext();
    
    const keyMap = { 'd':0, 'f':1, 'j':2, 'k':3 };
    const lane = keyMap[e.key.toLowerCase()];
    if(lane !== undefined) Game.check(lane);
    
    // Keyboard shortcuts
    if (e.key === 'm' || e.key === 'M') {
        const audioControl = document.getElementById('audioControl');
        audioControl.click();
        e.preventDefault();
    }
});

document.getElementById('start-btn').onclick = () => {
    Audio.playButton();
    Game.init();
};

// Prevent zoom on mobile
document.addEventListener('touchmove', (e) => {
    if (e.scale !== 1) {
        e.preventDefault();
    }
}, { passive: false });

// Prevent double tap zoom
let lastTouchEnd = 0;
document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
        e.preventDefault();
    }
    lastTouchEnd = now;
}, false);
</script>
</body>
</html>